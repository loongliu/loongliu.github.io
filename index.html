<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="刘怜苏">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="刘怜苏">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="刘怜苏">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>刘怜苏</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">刘怜苏</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/19/effective-objc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Jilong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘怜苏">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/19/effective-objc/" itemprop="url">Effective Objective-C 2.0 读书笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-19T11:56:06+08:00">
                2017-10-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Accustoming-Yourself-to-Objective-C"><a href="#Accustoming-Yourself-to-Objective-C" class="headerlink" title="Accustoming Yourself to Objective-C"></a>Accustoming Yourself to Objective-C</h1><h3 id="Item-1-Familiarize-Yourself-With-Objective-C’s-Roots"><a href="#Item-1-Familiarize-Yourself-With-Objective-C’s-Roots" class="headerlink" title="Item 1: Familiarize Yourself With Objective-C’s Roots:"></a>Item 1: Familiarize Yourself With Objective-C’s Roots:</h3><p>Objc是C的超集，给C语言添加了面向对象的特性。Objc使用了动态绑定，对象的类型推迟到运行时决定。<br>对于一个给定的消息，由Runtime而不是编译器决定运行哪个方法。</p>
<p>理解C语言的特性有助于写出高效的Objc代码，特别是内存模型和指针。</p>
<h3 id="Item-2：-Minimize-Importing-Headers-in-Headers"><a href="#Item-2：-Minimize-Importing-Headers-in-Headers" class="headerlink" title="Item 2： Minimize Importing Headers in Headers"></a>Item 2： Minimize Importing Headers in Headers</h3><p>使用前置声明（forword decalaring),而不是include头文件<br>在使用protocol时，无法使用前置声明。<br>这时候在extension中使用protocol，或者import一个只包含protocol的头文件。</p>
<h3 id="Item-3-Prefer-Literal-Syntax-over-the-Equivalent-Methods"><a href="#Item-3-Prefer-Literal-Syntax-over-the-Equivalent-Methods" class="headerlink" title="Item 3: Prefer Literal Syntax over the Equivalent Methods"></a>Item 3: Prefer Literal Syntax over the Equivalent Methods</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@<span class="string">"ok"</span>                    <span class="comment">// NSString</span></div><div class="line">@<span class="number">1</span>                       <span class="comment">// NSNumber</span></div><div class="line">@[@<span class="string">"1"</span>, @<span class="number">1</span>]              <span class="comment">// NSArray</span></div><div class="line">@&#123;@<span class="string">"1"</span>:@<span class="string">"2"</span>, @<span class="string">"2"</span>:@<span class="string">"4"</span>&#125;  <span class="comment">// NSDictionary</span></div></pre></td></tr></table></figure>
<p>Literal Array 相对于<code>arrayWithObjests:</code>的优势：<br>如果array中传入的内容包括nil，那么Literal Array会crash，<br>而<code>arrayWithObjests</code>会创建一个包含nil之前元素的array。</p>
<p>Literal Dictionary也有相同的问题。</p>
<h3 id="Item-4-Prefer-Typed-Constants-to-Proprocessor-define"><a href="#Item-4-Prefer-Typed-Constants-to-Proprocessor-define" class="headerlink" title="Item 4: Prefer Typed Constants to Proprocessor #define"></a>Item 4: Prefer Typed Constants to Proprocessor #define</h3><p>内部常量：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> NSTimeInterval kAnimationDuration = <span class="number">0.3</span>;</div></pre></td></tr></table></figure></p>
<p><code>static</code>表示常量只会在当前文件中，编译器不会为该常量创建一个外部符号。</p>
<p>外部常量：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// In the header File</span></div><div class="line"><span class="keyword">extern</span> NSString *<span class="keyword">const</span> EOCStringConstant;</div><div class="line"></div><div class="line"><span class="comment">// In the implementation File</span></div><div class="line">NSString* <span class="keyword">const</span> EOCStringConstant = @<span class="string">"VALUE"</span>;</div></pre></td></tr></table></figure></p>
<p>外部常量的命名需要符合objc的命名规范</p>
<h3 id="Item-5-Using-Enumerations-for-States-Options-and-Status-Codes"><a href="#Item-5-Using-Enumerations-for-States-Options-and-Status-Codes" class="headerlink" title="Item 5 Using Enumerations for States, Options, and Status Codes"></a>Item 5 Using Enumerations for States, Options, and Status Codes</h3><p>使用枚举(enum)来表示状态：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> EOCConnectionState &#123;</div><div class="line">  EOCConnectionStateDisconnected,</div><div class="line">  EOCConnectionStateConnecting,</div><div class="line">  EOCConnectionStateConnected,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>定义enum:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> EOCConnectionState state = EOCConnectionStateConnected;</div></pre></td></tr></table></figure></p>
<p>因此，通常使用在枚举定义中添加typedef:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> EOCConnectionState &#123;</div><div class="line">  EOCConnectionStateDisconnected,</div><div class="line">  EOCConnectionStateConnecting,</div><div class="line">  EOCConnectionStateConnected,</div><div class="line">&#125;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> EOCConnectionState EOCConnectionState;</div><div class="line">EOCConnectionState state = EOCConnectionStateConnected;</div></pre></td></tr></table></figure></p>
<p>Objc 提供了两个Macro： <code>NS_ENUM</code>和<code>NS_OPTIONS</code>,<br>两者的Macro展开方式在cplusplus下不一样。<br>如果需要使用bitwise OR操作，只能用<code>NS_OPTIONS</code>,使用<code>NS_ENUM</code>会触发错误。</p>
<p>在switch语句判断enum类型时，不要使用default语句。<br>当enum中添加新的类型时，编译器会提出警告，switch没有覆盖所有的分支。</p>
<h1 id="Objects-Messaging-and-the-Runtime"><a href="#Objects-Messaging-and-the-Runtime" class="headerlink" title="Objects, Messaging, and the Runtime"></a>Objects, Messaging, and the Runtime</h1><h3 id="Item-6-Understand-Properties"><a href="#Item-6-Understand-Properties" class="headerlink" title="Item 6: Understand Properties"></a>Item 6: Understand Properties</h3><p><code>@property</code>提供了一种封装数据和对象的方法<br>为property选择合适的attributes。</p>
<h3 id="Item-7-Access-Instance-Variables-Primarily-Directly-When-Accessing-Them-Internally"><a href="#Item-7-Access-Instance-Variables-Primarily-Directly-When-Accessing-Them-Internally" class="headerlink" title="Item 7: Access Instance Variables Primarily Directly When Accessing Them Internally"></a>Item 7: Access Instance Variables Primarily Directly When Accessing Them Internally</h3><p>setter/getter方法和操作实例变量的区别：</p>
<ol>
<li>操作实例变量不会触发Objc的方法分发过程，直接获取对象的内存，因此会更快。</li>
<li>操作实例变量绕过了setter/getter方法内存管理策略。</li>
<li>操作实例变量不会触发KVO(Key-Value Observing)机制</li>
<li>setter/getter方法更容易debug，因为可以在方法内部加断点。</li>
</ol>
<p>常用的策略：</p>
<ol>
<li>直接读取实例变量，使用setter方法进行写操作</li>
<li>在init方法和dealloc方法中，直接操作实例变量进行读写</li>
<li>lazy-init的数据，使用getter方法进行读操作</li>
</ol>
<h3 id="Item-8-Understand-Object-Equality"><a href="#Item-8-Understand-Object-Equality" class="headerlink" title="Item 8: Understand Object Equality"></a>Item 8: Understand Object Equality</h3><ol>
<li>需要检测Equality时，需要同时提供<code>isEqual:</code>和<code>hash</code>方法。</li>
<li>相等的对象需要有相同的hash，相同hash的对象不一定相等。</li>
<li>谨慎地选择哪些属性来判断相等</li>
<li>hash方法需要快速执行完毕，并且碰撞的概率较低。</li>
</ol>
<h3 id="Item-9-Use-the-Class-Cluster-Pattern-to-Hide-Implementation-Detail"><a href="#Item-9-Use-the-Class-Cluster-Pattern-to-Hide-Implementation-Detail" class="headerlink" title="Item 9: Use the Class Cluster Pattern to Hide Implementation Detail"></a>Item 9: Use the Class Cluster Pattern to Hide Implementation Detail</h3><p>Class Cluster pattern可以用来隐藏实现，在系统framework中大量使用。</p>
<p>使用<code>isKindof</code>做类型判断，而不是<code>isMemberof</code>, 更不是<code>==</code></p>
<h3 id="Item-10-Use-Associated-Objects-to-Attach-Custom-Data-to-Existing-Classes"><a href="#Item-10-Use-Associated-Objects-to-Attach-Custom-Data-to-Existing-Classes" class="headerlink" title="Item 10: Use Associated Objects to Attach Custom Data to Existing Classes"></a>Item 10: Use Associated Objects to Attach Custom Data to Existing Classes</h3><ol>
<li>Associated objects 提供了一种把两个对象关联在一起的方式</li>
<li>Associated objects 提供了类似于property的内存管理语义。</li>
<li>只有在在其他方法不能实现时，再去用Associated objects，因为很可能出现bug</li>
</ol>
<h3 id="Item-11-Understand-the-Role-of-objc-msgSend"><a href="#Item-11-Understand-the-Role-of-objc-msgSend" class="headerlink" title="Item 11: Understand the Role of objc_msgSend"></a>Item 11: Understand the Role of objc_msgSend</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">id</span> returnValue = [someObject messageName:parameter];</div><div class="line"></div><div class="line"><span class="keyword">id</span> returnValue = objc_msgSend(someObject, <span class="keyword">@selector</span>(messageName:), parameter);</div></pre></td></tr></table></figure>
<p>在objc中一个消息调用被runtime转化成一个c函数。</p>
<p>runtime会从someObject对应的类中查找selector的实现，如果没有找到实现，就会触发message forwarding的过程。</p>
<p>objc_msgSend会缓存查找的过程，因此只有第一次调用会进过查找的过程。</p>
<h3 id="Item-12-Understand-Message-Forwarding"><a href="#Item-12-Understand-Message-Forwarding" class="headerlink" title="Item 12: Understand Message Forwarding"></a>Item 12: Understand Message Forwarding</h3><p>Dynamic Method Resolution</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+ (BOOL)resolveInstanceMethod:(SEL)selector;</div></pre></td></tr></table></figure>
<p>这个方法会被调用，在方法的实现中，需要为类添加一个selector对应的实现，并返回YES，<br>或者返回NO，表示Dynamic Method Resolution失败。</p>
<p>Replacement Receiver</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (id)forwardingTargetForSelector:(SEL)selector;</div></pre></td></tr></table></figure>
<p>传入selector，方法接受者需要返回一个对象，由返回的对象来响应这个selector，<br>或者返回nil，表示ReplaceMent Receiver失败</p>
<p>Full Forwarding Mechanism<br>将selector和parameters构造出NSInvocation对象，并触发方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)forwardInvocation:(NSInvocation *)invocation;</div></pre></td></tr></table></figure></p>
<h3 id="Item-13-Consider-Method-Swizzling-to-Debug-Opaque-Methods"><a href="#Item-13-Consider-Method-Swizzling-to-Debug-Opaque-Methods" class="headerlink" title="Item 13: Consider Method Swizzling to Debug Opaque Methods"></a>Item 13: Consider Method Swizzling to Debug Opaque Methods</h3><p>可以在runtime替换一个selector对应的实现。</p>
<p>可以使用Method Swizzling来替换一个selector的实现，在原先的实现上添加更多的功能。</p>
<h3 id="Item-14-Understand-What-a-Class-Object-is"><a href="#Item-14-Understand-What-a-Class-Object-is" class="headerlink" title="Item 14: Understand What a Class Object is"></a>Item 14: Understand What a Class Object is</h3><p>objc_object结构中有一个isa指针，指向对象的Class结构体。<br>objc_class结构中也有一个isa指针，指向Class的meta class</p>
<p><code>isKindof:</code>和<code>isMemberof:</code>可以用来确定对象的Class</p>
<h1 id="Interface-and-API-Design"><a href="#Interface-and-API-Design" class="headerlink" title="Interface and API Design"></a>Interface and API Design</h1><h3 id="Item-15-Using-Prefix-Names-to-Avoid-NameSpace-Clashes"><a href="#Item-15-Using-Prefix-Names-to-Avoid-NameSpace-Clashes" class="headerlink" title="Item 15: Using Prefix Names to Avoid NameSpace Clashes"></a>Item 15: Using Prefix Names to Avoid NameSpace Clashes</h3><p>需要命名空间前缀的命名：</p>
<p>类名，protocol名，全局变量/常量，全局方法，系统类的category，category中的方法名</p>
<h3 id="Item-16-Have-a-Designated-Initializer"><a href="#Item-16-Have-a-Designated-Initializer" class="headerlink" title="Item 16: Have a Designated Initializer"></a>Item 16: Have a Designated Initializer</h3><p>class需要一个Designated Initializer，并且需要文档进行标注。<br>所有其他的init方法都要调用这个方法进行初始化</p>
<p>如果Designated Initializer与父类不一致，那么需要override父类的Designated Initializer</p>
<p>子类中不能使用的init方法，要override并且抛出异常，或者标注NS_UNAVAILABLE.</p>
<h3 id="Item-17-Implement-the-description-Method"><a href="#Item-17-Implement-the-description-Method" class="headerlink" title="Item 17: Implement the description Method"></a>Item 17: Implement the description Method</h3><p>一个很好的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (NSString* ）description&#123;</div><div class="line">  return [NSString stringWithFormat:@&quot;&lt;%@:%p, %@&gt;&quot;,</div><div class="line">          [self class],</div><div class="line">          self,</div><div class="line">          @&#123;@&quot;title&quot;: _title,</div><div class="line">          @&quot;latitude&quot;:@(_latitude),</div><div class="line">          @&quot;longitude&quot;:@(_longitude)&#125;</div><div class="line">          ];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将class，指针类型打印出来，并将关键属性以Dictionary的形式打印。</p>
<p>另外，console中调试指令po会触发’debugDescription’方法。</p>
<h3 id="Item-18-Prefer-Immutable-Objects"><a href="#Item-18-Prefer-Immutable-Objects" class="headerlink" title="Item 18: Prefer Immutable Objects"></a>Item 18: Prefer Immutable Objects</h3><p>尽可能将对象设置为不可变的</p>
<p>在h文件中设置readonly，在m文件中的extension设置readwrite</p>
<p>对于可变的集合，给出一个方法返回Immutable集合，内部使用Mutable集合。</p>
<h3 id="Item-19-Use-Clear-and-Consistent-Naming"><a href="#Item-19-Use-Clear-and-Consistent-Naming" class="headerlink" title="Item 19: Use Clear and Consistent Naming"></a>Item 19: Use Clear and Consistent Naming</h3><p>遵循Objc的命名规范， 方法名是准确并具体的，符合从左向右的阅读喜感，避免使用缩写，<br>与现有的代码保持相同的规范</p>
<h3 id="Item-20-Prefix-Private-Method-Names"><a href="#Item-20-Prefix-Private-Method-Names" class="headerlink" title="Item 20: Prefix Private Method Names"></a>Item 20: Prefix Private Method Names</h3><p>给私有方法添加前缀，容易与公有方法做出区分</p>
<p>避免使用下划线作为前缀，因为Apple会这么做。</p>
<h3 id="Item-21-Understand-the-Objective-C-Error-Model"><a href="#Item-21-Understand-the-Objective-C-Error-Model" class="headerlink" title="Item 21: Understand the Objective-C Error Model"></a>Item 21: Understand the Objective-C Error Model</h3><p>在Objc中，很少会使用异常，只有在无法恢复，并且会导致应用退出的时候，才适合使用异常。</p>
<p>对于其他的异常，可以通过返回nil/特定值来表示异常。</p>
<p>另一种方式是使用NSError。</p>
<h3 id="Item-22-Understand-the-NSCoping-Protocol"><a href="#Item-22-Understand-the-NSCoping-Protocol" class="headerlink" title="Item 22: Understand the NSCoping Protocol"></a>Item 22: Understand the <strong>NSCoping</strong> Protocol</h3><p>如果对象可以被复制，那么实现NSCoping协议</p>
<p>如果对象有mutable和immutable版本，那么需要实现NSCoping和NSMutableCoping方法</p>
<p>选择潜复制还是深复制</p>
<p>如果需要深复制，添加一个deepCopy方法。</p>
<h1 id="Protocols-and-Categories"><a href="#Protocols-and-Categories" class="headerlink" title="Protocols and Categories"></a>Protocols and Categories</h1><h3 id="Item-23-Use-Delegate-and-Data-Source-Protocols-for-Interobject-Communication"><a href="#Item-23-Use-Delegate-and-Data-Source-Protocols-for-Interobject-Communication" class="headerlink" title="Item 23: Use Delegate and Data Source Protocols for Interobject Communication"></a>Item 23: Use Delegate and Data Source Protocols for Interobject Communication</h3><p>Info Flow: DataSource -&gt; Class -&gt; Delegate</p>
<p>如果有需要的话，实现一个bitfield结构，<br>缓存了一个delegate是否responseTo protocol的对应的方法。</p>
<h3 id="Item-24-Use-Categories-to-Break-Class-Implementations-into-Manageable-Segments"><a href="#Item-24-Use-Categories-to-Break-Class-Implementations-into-Manageable-Segments" class="headerlink" title="Item 24: Use Categories to Break Class Implementations into Manageable Segments"></a>Item 24: Use Categories to Break Class Implementations into Manageable Segments</h3><p>使用category拆分功能，减少每个文件的长度。</p>
<p>添加一个Private Category将内部接口和外部接口做区分。在framework中用到</p>
<h3 id="Item-25-Always-Prefix-Category-Names-on-Third-Party-Classes"><a href="#Item-25-Always-Prefix-Category-Names-on-Third-Party-Classes" class="headerlink" title="Item 25: Always Prefix Category Names on Third-Party Classes"></a>Item 25: Always Prefix Category Names on Third-Party Classes</h3><p>category名和category中的方法名都要添加前缀。</p>
<h3 id="Item-26-在Category中避免使用属性"><a href="#Item-26-在Category中避免使用属性" class="headerlink" title="Item 26: 在Category中避免使用属性"></a>Item 26: 在Category中避免使用属性</h3><p>所有的属性都应该声明在主类中。</p>
<p>在category中添加实例变量可以通过associatedObject来实现</p>
<h3 id="Item-27-Use-the-Class-Continuation-Category-to-Hide-Implementation-Detail"><a href="#Item-27-Use-the-Class-Continuation-Category-to-Hide-Implementation-Detail" class="headerlink" title="Item 27: Use the Class-Continuation Category to Hide Implementation Detail"></a>Item 27: Use the Class-Continuation Category to Hide Implementation Detail</h3><p>使用类Extension可以添加实力变量， 私有方法</p>
<p>使用Extension可以声明</p>
<p>可以在Extension中将readonly属性声明为readwrite，在内部允许修改</p>
<h3 id="Item-28-Use-a-Protocol-to-Provide-Anonymous-Objects"><a href="#Item-28-Use-a-Protocol-to-Provide-Anonymous-Objects" class="headerlink" title="Item 28: Use a Protocol to Provide Anonymous Objects"></a>Item 28: Use a Protocol to Provide Anonymous Objects</h3><p>将Protocol作为函数参数和返回值能够提供一定成都的抽象。</p>
<p>在类名必须被隐藏，或者类型与功能无关时，可以使用protocol代表的匿名对象。</p>
<h1 id="Memory-Management"><a href="#Memory-Management" class="headerlink" title="Memory Management"></a>Memory Management</h1><h3 id="Item-29-Understand-Reference-Counting"><a href="#Item-29-Understand-Reference-Counting" class="headerlink" title="Item 29: Understand Reference Counting"></a>Item 29: Understand Reference Counting</h3><p>Objc使用引用计数做内存管理。</p>
<p>会改变引用计数计数的操作：</p>
<p>创建后的对象 retainCount 至少为1</p>
<p><code>retain</code> retainCount +1</p>
<p><code>release</code> retainCount -1</p>
<p><code>autorelease</code> retainCount -1 when autorelease pool drained</p>
<p>当对象的<code>retainCount</code>变成0的时候，这个对象就会被释放掉。</p>
<h3 id="Item-30-Use-ARC-to-Make-Reference-Counting-Easier"><a href="#Item-30-Use-ARC-to-Make-Reference-Counting-Easier" class="headerlink" title="Item 30: Use ARC to Make Reference Counting Easier"></a>Item 30: Use ARC to Make Reference Counting Easier</h3><p>ARC在合适的位置添加retain和release，<br>变量的修饰符 <code>__strong</code>,<code>__weak</code>可以修改默认的内存管理策略。</p>
<p>ARC只对Objc对象有效，CoreFoundation对象无效，需要自行调用CFRetain/CFRelease.</p>
<h3 id="Item-31-Release-References-and-Clean-Up-Observation-State-Only-in-dealloc"><a href="#Item-31-Release-References-and-Clean-Up-Observation-State-Only-in-dealloc" class="headerlink" title="Item 31: Release References and Clean Up Observation State Only in dealloc"></a>Item 31: Release References and Clean Up Observation State Only in dealloc</h3><p>在<code>dealloc</code>方法中释放必要的资源，释放CoreFoundation对象，释放Observer等等。</p>
<p>在<code>dealloc</code>中不能做异步调用，也不能做太耗时的操作</p>
<p>如果对象持有系统资源，比如fd，socket等，应该提供一个方法释放这些资源，<br>并要求外部调用者在对象<code>dealloc</code>之前调用释放方法。</p>
<h3 id="Item-32-Beware-of-Memory-Management-with-Exception-Safe-Code"><a href="#Item-32-Beware-of-Memory-Management-with-Exception-Safe-Code" class="headerlink" title="Item 32: Beware of Memory Management with Exception-Safe Code"></a>Item 32: Beware of Memory Management with Exception-Safe Code</h3><p>当捕获异常的时候，需要确保try语句中的对象被合理地释放</p>
<p>当捕获异常时，默认不会处理对象的释放。如果开启了<code>-fobjc-arc-expections</code>,<br>能够很好地处理对象释放，但是会产生很多额外代码，并产生Runtime Cost.</p>
<h3 id="Item-33-Use-Weak-References-to-Avoid-Retain-Cycles"><a href="#Item-33-Use-Weak-References-to-Avoid-Retain-Cycles" class="headerlink" title="Item 33: Use Weak References to Avoid Retain Cycles"></a>Item 33: Use Weak References to Avoid Retain Cycles</h3><p>循环引用可以通过<code>weak</code>和<code>unsafe_unretained</code>的方式来解决。</p>
<p><code>weak</code>会被autonil， <code>unsafe_unretained</code>不会autonil。</p>
<h3 id="Item-34-Use-Autorelease-Pool-Blocks-to-Reduce-High-Memory-Waterline"><a href="#Item-34-Use-Autorelease-Pool-Blocks-to-Reduce-High-Memory-Waterline" class="headerlink" title="Item 34: Use Autorelease Pool Blocks to Reduce High-Memory Waterline"></a>Item 34: Use Autorelease Pool Blocks to Reduce High-Memory Waterline</h3><p>Autorelease对象什么时候被释放：</p>
<p>当前autoreleasepool被pop的时候。</p>
<p>Cocoa中系统创建的线程，每次线程执行完一个event loop<br>都会执行异常autoreleasepool的drain操作。<br>autoreleasepool中的autorelease对象都会被释放。</p>
<p>autoreleasepool组成一个stack结构，对象被添加在最顶层的autoreleasepool中。</p>
<p>手动添加autoreleasepool,并在合适的时候pop，可以提前释放内存。</p>
<h3 id="Item-35-Use-Zombies-to-Help-Debug-Memory-Management-Problems"><a href="#Item-35-Use-Zombies-to-Help-Debug-Memory-Management-Problems" class="headerlink" title="Item 35: Use Zombies to Help Debug Memory-Management Problems."></a>Item 35: Use Zombies to Help Debug Memory-Management Problems.</h3><p>向一个被dealloc的对象传递消息是不安全的。<br>因为对象的内存仍然有效，有可能已经被重写。<br>因此应用可能会crash，或者不正常地继续执行。</p>
<p>Cocoa提供”Zombies”特性，开启后，dealloc的对象不会被释放，而是转化成一个zoombie对象。<br>向zombie对象发送消息时，会显示一段日志并跳入调试器。</p>
<p>Zoombie的实现也很有意思，每个class都有一个对应的ZoombieClass，<br>这个ZoombieClass由默认的zoombieClass复制实现，并修改来classname.</p>
<h3 id="Item-36-Avoid-Using-retainCount"><a href="#Item-36-Avoid-Using-retainCount" class="headerlink" title="Item 36: Avoid Using retainCount"></a>Item 36: Avoid Using retainCount</h3><p>在MRC情况下，retainCount并不准确，不能用于生成代码，也不能用来调试。</p>
<p>在ARC情况下，retainCount被废弃了。</p>
<h1 id="Blocks-and-Grand-Central-Dispatch"><a href="#Blocks-and-Grand-Central-Dispatch" class="headerlink" title="Blocks and Grand Central Dispatch"></a>Blocks and Grand Central Dispatch</h1><h3 id="Item-37-Understand-Blocks"><a href="#Item-37-Understand-Blocks" class="headerlink" title="Item 37: Understand Blocks"></a>Item 37: Understand Blocks</h3><p>block是一个对象，有对应的类型。<br>block的语法与函数指针很相似。<br>提供了闭包的功能。在block中可以使用block声明时可用的对象。</p>
<p>修改这些对象需要对象具有<code>__block</code>属性。</p>
<p>block有三种类型：<br> Global， 存储在数据区<br> Stack，  存储在栈上<br> Malloc， 存储在堆上。</p>
<p>GlobalBlock： 在block内没有引用任何外部变量</p>
<p>StackBlock：  在block内引用了外部变量</p>
<p>MallocBlock:  对StackBlock进行copy操作，会变成MallocBlock， 存储区域发生变化。</p>
<p>在MRC下，需要手动调用copy，转化为MallocBlock，<br>在ARC下，StackBlock赋值给强引用时，会自动调用copy.</p>
<h3 id="Item-38-Create-typedefs-for-Common-Block-Types"><a href="#Item-38-Create-typedefs-for-Common-Block-Types" class="headerlink" title="Item 38: Create typedefs for Common Block Types"></a>Item 38: Create typedefs for Common Block Types</h3><p>block的声明比较难写，用typedef会简化使用</p>
<p>在typedef时要注意命名规范</p>
<p>对于同样类型的block，可以根据功能声明不同的typedef</p>
<h3 id="Item-39-Use-Handler-Blocks-to-Reduce-Code-Separation"><a href="#Item-39-Use-Handler-Blocks-to-Reduce-Code-Separation" class="headerlink" title="Item 39: Use Handler Blocks to Reduce Code Separation"></a>Item 39: Use Handler Blocks to Reduce Code Separation</h3><p>使用handler block能够将相关的代码写在一起。</p>
<p>当使用handler block时，最好能够允许传入queue，由调用者决定在传入的queue执行block</p>
<h3 id="Item-40-Avoid-Retain-Cycles-Introduced-by-Blocks-Referencing-the-Object-Owning-Them"><a href="#Item-40-Avoid-Retain-Cycles-Introduced-by-Blocks-Referencing-the-Object-Owning-Them" class="headerlink" title="Item 40: Avoid Retain Cycles Introduced by Blocks Referencing the Object Owning Them."></a>Item 40: Avoid Retain Cycles Introduced by Blocks Referencing the Object Owning Them.</h3><p>block很容易引入循环引用</p>
<h3 id="Item-41-Prefer-Dispatch-Queues-to-Locks-for-Synchronization"><a href="#Item-41-Prefer-Dispatch-Queues-to-Locks-for-Synchronization" class="headerlink" title="Item 41: Prefer Dispatch Queues to Locks for Synchronization"></a>Item 41: Prefer Dispatch Queues to Locks for Synchronization</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (NSString* )someString &#123;</div><div class="line">  @synchronized(self)&#123;</div><div class="line">    return _something;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void) setSomething:(NSString* )something &#123;</div><div class="line">  @synchronized(self)&#123;</div><div class="line">    _something = something;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以使用Dispatch Queue来替代这个实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">_syncQueue = dispatch_queue_create(&quot;com.fff.xxx.syncQueue&quot;, NULL);</div><div class="line"></div><div class="line">- (NSString* )someString &#123;</div><div class="line">  __block NSString* localSomething;</div><div class="line">  dispatch_sync(_syncQueue, ^&#123;</div><div class="line">    localSomething = _something;</div><div class="line">  &#125;);</div><div class="line">  return localSomething;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)setSomeString:(NSString* )someString &#123;</div><div class="line">  dispatch_sync(_syncQueue, ^&#123;</div><div class="line">    _someStirng = someString;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这种情况下，setter方法可以做成异步的，因为setter方法并不需要返回值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)setSomeString:(NSString* )someString &#123;</div><div class="line">  dispatch_async(_syncQueue, ^&#123;</div><div class="line">    _someStirng = someString;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用barriar后，可以使用并发的队列：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">_syncQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</div><div class="line"></div><div class="line">- (NSString* )someString &#123;</div><div class="line">  __block NSString* localSomething;</div><div class="line">  dispatch_sync(_syncQueue, ^&#123;</div><div class="line">    localSomething = _something;</div><div class="line">  &#125;);</div><div class="line">  return localSomething;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)setSomeString:(NSString* )someString &#123;</div><div class="line">  dispatch_barriar_async(_syncQueue, ^&#123;</div><div class="line">    _someStirng = someString;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Item-42-Prefer-GCD-to-performSelector-and-Friends"><a href="#Item-42-Prefer-GCD-to-performSelector-and-Friends" class="headerlink" title="Item 42: Prefer GCD to performSelector and Friends"></a>Item 42: Prefer GCD to <code>performSelector</code> and Friends</h3><p><code>preformSelector</code>方法在内存管理方面可能会有风险。<br>并且对参数个数，返回值类型有限制<br>GCD提供更好的选择。</p>
<h3 id="Item-43-Know-When-to-Use-GCD-and-When-to-Use-Operation-Queues"><a href="#Item-43-Know-When-to-Use-GCD-and-When-to-Use-Operation-Queues" class="headerlink" title="Item 43: Know When to Use GCD and When to Use Operation Queues"></a>Item 43: Know When to Use GCD and When to Use Operation Queues</h3><p>NSOperationQueue底层由GCD实现，提供类似的功能，不同点：</p>
<p>NSOperationQueue提供cancel功能<br>NSOperationQueue提供依赖。<br>NSOperation的很多属性有KVO功能<br>NSOperation有优先级功能。<br>NSOperation子类具有很大的自由度，相对于block</p>
<h3 id="Item-44-Use-Dispatch-Groups-to-Take-Advantage-of-Platform-Scaling"><a href="#Item-44-Use-Dispatch-Groups-to-Take-Advantage-of-Platform-Scaling" class="headerlink" title="Item 44: Use Dispatch Groups to Take Advantage of Platform Scaling"></a>Item 44: Use Dispatch Groups to Take Advantage of Platform Scaling</h3><p>dispatch_group可以用来做block同步。</p>
<h3 id="Item-45-Use-dispatch-once-for-Thread-Safe-Single-Time-Code-Execution"><a href="#Item-45-Use-dispatch-once-for-Thread-Safe-Single-Time-Code-Execution" class="headerlink" title="Item 45: Use dispatch_once for Thread-Safe Single-Time Code Execution"></a>Item 45: Use dispatch_once for Thread-Safe Single-Time Code Execution</h3><p>GCD提供来一个容易使用的工具: dispatch_once, 效率更高</p>
<p>token应该被声明为static or Global</p>
<h3 id="Item-46-Avoid-dispatch-get-current-queue"><a href="#Item-46-Avoid-dispatch-get-current-queue" class="headerlink" title="Item 46: Avoid dispatch_get_current_queue"></a>Item 46: Avoid dispatch_get_current_queue</h3><p>dispatch_queue是一个层次结构，当前的queue不能通过一个简单的queue对象来表示。</p>
<p>所以dispatch_get_current_queue不能很好地工作。</p>
<h1 id="The-System-Framework"><a href="#The-System-Framework" class="headerlink" title="The System Framework"></a>The System Framework</h1><h3 id="Item-47-Familiarize-Yourself-with-the-System-Frameworks"><a href="#Item-47-Familiarize-Yourself-with-the-System-Frameworks" class="headerlink" title="Item 47: Familiarize Yourself with the System Frameworks"></a>Item 47: Familiarize Yourself with the System Frameworks</h3><h3 id="Item-48-Prefer-Block-Enumeration-to-for-Loops"><a href="#Item-48-Prefer-Block-Enumeration-to-for-Loops" class="headerlink" title="Item 48: Prefer Block Enumeration to for Loops"></a>Item 48: Prefer Block Enumeration to for Loops</h3><p>objc当前支持的Enumeration的方法：<br>for-loop<br>NSEnumerator<br>Fast Enumeration (for-in)<br>Block based Enumeration:  <code>enumerateObjectsUsingBlock:</code></p>
<h3 id="Item-49-Use-Toll-Free-Bridging-for-Collections-with-Custom-Memory-Management-Sematics"><a href="#Item-49-Use-Toll-Free-Bridging-for-Collections-with-Custom-Memory-Management-Sematics" class="headerlink" title="Item 49: Use Toll-Free Bridging for Collections with Custom Memory-Management Sematics"></a>Item 49: Use Toll-Free Bridging for Collections with Custom Memory-Management Sematics</h3><p>在Foundation的objc对象和CoreFoundation对象之间可以进行toll-free bridging</p>
<p>CoreFoundation对象支持更精细的内存管理</p>
<h3 id="Item-50-Use-NSCache-Instead-of-NSDictionary-for-Caches"><a href="#Item-50-Use-NSCache-Instead-of-NSDictionary-for-Caches" class="headerlink" title="Item 50: Use NSCache Instead of NSDictionary for Caches"></a>Item 50: Use NSCache Instead of NSDictionary for Caches</h3><p>NSCache 保证了线程安全，并且不复制Keys</p>
<h3 id="Item-51-Keep-initialize-and-load-Implementations-Lean"><a href="#Item-51-Keep-initialize-and-load-Implementations-Lean" class="headerlink" title="Item 51: Keep initialize and load Implementations Lean"></a>Item 51: Keep initialize and load Implementations Lean</h3><p>类在加载过程中会触发load方法，cateogory也有load方法，类的load会在category的load之前调用</p>
<p>load不会被继承</p>
<p>class第一次被使用时，会触发initialize方法，initialize方法会被继承。<br>这两个方法的实现应该尽量简单。</p>
<h3 id="Item-52-Remember-that-NSTimer-Retains-Its-Target"><a href="#Item-52-Remember-that-NSTimer-Retains-Its-Target" class="headerlink" title="Item 52: Remember that NSTimer Retains Its Target"></a>Item 52: Remember that NSTimer Retains Its Target</h3><p>NSTimer持有target直到NSTimer失效。<br>可能引入循环引用。<br>扩展NSTimer，使用block可以打破循环引用。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/30/PCA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Jilong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘怜苏">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/30/PCA/" itemprop="url">主成分分析(PCA)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-30T20:57:27+08:00">
                2017-06-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>主成分分析是特征工程中对数据进行处理对过程。处理得到的结果是数据中最重要的纬度，舍弃不重要的纬度。</p>
<p>举个简单的例子，对于一组数据（1,0), (2,0) (3,0)。 这组数据有两个纬度，<br>但是第二个纬度都为零。可以把第二个纬度数据完全删除而不丢失信息。</p>
<p>这里需要一个衡量纬度重要程度的量：方差。数据在一个纬度上的方差越大，这个纬度越重要。对于上面这组数据。第一个纬度上的方差为2，第二个纬度的方差为0.在进行主成分分析时，第二个纬度被舍弃。</p>
<p>对于未知的数据，各个纬度的方差可能差距不大，需要对数据做线性变换，使得不同纬度的方差变化较大。<br>第一个纬度的方差最大，最后一个纬度的方差最小。同时不同纬度的数据没有相关性。</p>
<p>不同维度的相关性用协方差来表示：</p>
<p>$$Cov(X,Y) = E[(X-\mu_x)(Y-\mu_y)]$$</p>
<p>方差：</p>
<p>$$Var(X) = E[(X-\mu_x)^2]$$</p>
<p>对于一组数据$X<em>{M*N}$, $M$为特征的个数，$N$为样本的个数。$X</em>{m<em>n}$表示第$n$个样本第$m$个特征的值。执行PCA过程后得到数据$Y_{M</em>N}$.<br>$M$不同特征的数据协方差为0，$Y$的第一个纬度的方差最大，最后一个纬度的方差最小。</p>
<p>假设矩阵$X$进行过中心化后，即$\sum_mX_m=0$，那么每个纬度的方差可以表示为：<br>$$Var(X_m) = \frac{1}{N}\sum<em>nX</em>{mn}^2 \qquad  (m=0,1,2,…,M)$$<br>不同纬度的协方差可以表示为<br>$$Cov(X_{m<em>1},X</em>{m_2}) = \frac{1}{n}\sum<em>nX</em>{m<em>1n}X</em>{m_2n} \qquad (m_1,m_2=0,1,2,…,M)$$</p>
<p>矩阵$X$不同纬度方差和协方差可以很方便地在$XX^T$中表示。<br>$$(XX^T)_{m,m} = Var(X<em>m)$$<br>$$(XX^T)</em>{m_1,m<em>2} = Cov(X</em>{m<em>1},X</em>{m_2})$$</p>
<p>选择合适地线性变换矩阵$P$，$Y<em>{Y*N} = P</em>{Y<em>M}</em>X_{M,N}$,使得$(PX)(PX)^T$为对角矩阵。</p>
<p>这对应于对$XX^T$的对角化。</p>
<p>$XX^T$就称为$X$的协方差矩阵。PCA的过程等价于协方差矩阵的对角化过程。</p>
<p>问题：对角化矩阵唯一吗？</p>
<p>在域$F$上的矩阵$A_{N*N}$是可对角化的，当且仅当它的特征空间纬度等于$N$，当且仅当A有$N<br>个特征值，并且对应当特征向量组成向量空间的一组基。</p>
<p>如果找到了这样的一组基，可以将基作为纵列，按特征值大小依次排列成矩阵$P$，那么$P^{-1}AP$是对角矩阵，对角线元素为对应的特征值。</p>
<p>$P$便是<code>PCA</code>过程中的变换矩阵，$P^{-1}AP$便是PCA得到的结果，选取较大的K个特征值得到对应的主成分。</p>
<p>PCA是一个信息提取的过程，将原始数据降维，<br>ICA认为观测信号是若干个统计独立的分量的线性组合，ICA要做的是一个解混过程</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/26/knn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Jilong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘怜苏">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/26/knn/" itemprop="url">使用python实现KNN算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-26T17:04:19+08:00">
                2017-05-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="KNN算法介绍"><a href="#KNN算法介绍" class="headerlink" title="KNN算法介绍"></a>KNN算法介绍</h2><p>KNN（K Nearest Neighbour, k近邻法）是一种基础的分类算法。<br>分类算法分两个步骤：拟合和预测，<br>首先将使用训练数据进行拟合，<br>然后使用拟合的模型对测试数据进行预测。<br>很多分类方法（比如逻辑回归，支持状态机）会从训练数据中学习得到一个范化的模型，<br>然后使用模型对测试数据进行分类。KNN在拟合的过程只是简单地将输入和输出数据保存下来。<br>分类算法集中在预测步骤中。</p>
<p>KNN算法简单，直接。给定一个训练数据集。对于测试实例，在训练数据集中寻找到距离测试实例最近的<br>K个实例。这K个实例按分类进行投票，票数最多的分类就是测试数据的分类。</p>
<p><img src="http://tuchang-1253208593.costj.myqcloud.com/440px-KnnClassification.svg.png" alt=""></p>
<p>对于上图给出的数据。红色和蓝色点为训练数据集，不同颜色代表两个不同的分类。绿色点为测试实例。<br>在K=3的情况下，实线圈内的三个训练实例是离测试实例最近的，<br>按照KNN的投票方案，绿色测试实例的类别为红色。<br>而在K=5的情况下，则虚线圈内的五个实例进行投票，绿色测试实例的类别为蓝色。</p>
<h2 id="KNN算法特点"><a href="#KNN算法特点" class="headerlink" title="KNN算法特点"></a>KNN算法特点</h2><h4 id="K的选择"><a href="#K的选择" class="headerlink" title="K的选择"></a>K的选择</h4><p>不同的K值会对分类结果产生影响。选择合适的K值取决于训练数据的特点。<br>较小的K值能更好地拟合训练数据的特点，同时会带来严重的过拟合问题。<br>较大的K值能减少噪声的影响，但是也会削弱类别之间的界限。</p>
<p>对于具体数据，K的选择通常需要超参数优化来完成。</p>
<h4 id="距离"><a href="#距离" class="headerlink" title="距离"></a>距离</h4>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/04/弹幕/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Jilong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘怜苏">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/04/弹幕/" itemprop="url">Mac弹幕库BarrageRenderer代码解读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-04T20:09:40+08:00">
                2017-05-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近需要在Mac平台上实现弹幕的功能。<br>花了一点点时间实现了一个简单的版本，但是弹幕的渲染效率堪忧。<br>在Github上搜索了一下找到了<a href="https://github.com/unash/BarrageRenderer" target="_blank" rel="external">BarrageRenderer</a>这个开源库。<br>读了读代码，在这里记录下心得。</p>
<h2 id="主要类的功能分析"><a href="#主要类的功能分析" class="headerlink" title="主要类的功能分析"></a>主要类的功能分析</h2><p>BarrageSprite: 弹幕精灵类，实例变量<code>_view</code>为弹幕实际的View。<br>BarrageSprite负责弹幕的位置更新，存活判断。<code>_view</code>负责弹幕的绘制。<br>这样的设计将不同功能的代码解耦，而且相同的位置更新逻辑可以在不同界面的<code>_view</code>中使用。</p>
<p>BarrageCanvas: 继承<code>UIView</code>，弹幕界面类。所有的弹幕都添加到这个View中。<br>这个类的代码很少，可以扩展的内容很多，滑动操作，点击操作都可以在这个View中实现。</p>
<p>BarrageClock：使用DisplayLink实现了定时器。用来定时刷新弹幕界面。<br>维护了一个时间系统。这个时间系统提供给BarrageSprite做位置更新。</p>
<p>BarrageDispatcher: 弹幕调度器。实例变量<code>_waitingSprites</code>和<code>_activeSprites</code>保存了当前等待的弹幕和实际显示的弹幕。</p>
<h2 id="弹幕的创建过程"><a href="#弹幕的创建过程" class="headerlink" title="弹幕的创建过程"></a>弹幕的创建过程</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BarrageRenderer.m</span></div><div class="line">- (<span class="keyword">void</span>)receive:(BarrageDescriptor *)descriptor</div><div class="line">&#123;</div><div class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">        <span class="keyword">if</span> (!_startTime) &#123; <span class="comment">// 如果没有启动,则抛弃接收弹幕</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        BarrageDescriptor * descriptorCopy = [descriptor <span class="keyword">copy</span>];</div><div class="line">        [<span class="keyword">self</span> convertDelayTime:descriptorCopy];</div><div class="line">        BarrageSprite * sprite = [BarrageSpriteFactory createSpriteWithDescriptor:descriptorCopy];</div><div class="line">        [_dispatcher addSprite:sprite];</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>BarrageRenderer</code>的<code>receive</code>方法可以接收一条弹幕描述符<code>BarrageDescriptor</code>.<br>将弹幕的延迟时间转换后生成一个<code>BarrageSprite</code>对象。<br>这个时候<code>BarrageSprite</code>对应的<code>_view</code>并没有创建。<code>_view</code>在弹幕被激活的时候创建。<br>然后调用<code>BarrageDispatcher</code>的<code>addSprite</code>方法将<code>BarrageSprite</code>加入到<code>Dispatcher</code>中。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// BarrageRenderer.m</span></div><div class="line">- (<span class="keyword">void</span>)addSprite:(BarrageSprite *)sprite</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> ([sprite isKindOfClass:[BarrageSprite <span class="keyword">class</span>]]) &#123;</div><div class="line">        [_waitingSprites addObject:sprite];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>BarrageDispatcher</code>的<code>addSprite</code>方法很简单，对BarrageSprite做类型判断后加入到等待队列中。<br>后面在每一帧操作中，对等待队列中对<code>BarrageSprite</code>进行判断是否可以激活。</p>
<p>每一帧更新对方法是<code>BarrageRenderer</code>中的<code>update</code>方法。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BarrageRenderer.m</span></div><div class="line">- (<span class="keyword">void</span>)update</div><div class="line">&#123;</div><div class="line">    [_dispatcher dispatchSprites]; <span class="comment">// 对弹幕的状态进行判断。</span></div><div class="line">    <span class="keyword">for</span> (BarrageSprite * sprite <span class="keyword">in</span> _dispatcher.activeSprites) &#123;</div><div class="line">        [sprite updateWithTime:_time];  <span class="comment">// 对激活弹幕的位置进行更新</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>update</code>方法分为两部分，一部分是对弹幕状态变化进行判断，<br>等待状态进入激活状态，激活状态进入死亡状态。<br>第二部分是对激活弹幕对位置进行更新。</p>
<p>我们先看<code>dispatchSprites</code>方法:<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)dispatchSprites</div><div class="line">&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; _activeSprites.count; i ++) &#123;</div><div class="line">        BarrageSprite * sprite = [_activeSprites objectAtIndex:i];</div><div class="line">        <span class="keyword">if</span> (!sprite.isValid) &#123;</div><div class="line">            [<span class="keyword">self</span> deactiveSprite:sprite];</div><div class="line">            [_activeSprites removeObjectAtIndex:i--];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">NSTimeInterval</span> <span class="keyword">const</span> MAX_EXPIRED_SPRITE_RESERVED_TIME = <span class="number">0.5</span>f; <span class="comment">// 弹幕最大保留时间</span></div><div class="line">    <span class="built_in">NSTimeInterval</span> currentTime = [<span class="keyword">self</span> currentTime];</div><div class="line">    <span class="built_in">NSTimeInterval</span> timeWindow = currentTime - _previousTime; <span class="comment">// 有可能为正,也有可能为负(如果倒退的话)</span></div><div class="line">    <span class="keyword">if</span> (timeWindow &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; _waitingSprites.count; i++) &#123;</div><div class="line">            BarrageSprite * sprite = [_waitingSprites objectAtIndex:i];</div><div class="line">            <span class="built_in">NSTimeInterval</span> overtime = currentTime - sprite.delay;</div><div class="line">            <span class="keyword">if</span> (overtime &gt;= <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (overtime &lt; timeWindow &amp;&amp; overtime &lt;= MAX_EXPIRED_SPRITE_RESERVED_TIME) &#123;</div><div class="line">                    <span class="keyword">if</span> ([<span class="keyword">self</span> shouldActiveSprite:sprite]) &#123;</div><div class="line">                        [<span class="keyword">self</span> activeSprite:sprite];</div><div class="line">                        [_activeSprites addObject:sprite];</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                [_waitingSprites removeObjectAtIndex:i--];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    _previousTime = currentTime;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>dispatchSprites</code>方法中，首先遍历激活状态的弹幕，如果弹幕不再有效，<br>就调用<code>deactiveSprite</code>方法将弹幕失效，并从<code>_activeSprites</code>队列中移除。<br>然后对等待队列中已经可以激活的弹幕，调用<code>activeSprite</code>方法，<br>将弹幕激活，并加入到<code>_activeSprites</code>队列中。<br>这里判断弹幕激活使用的时间是BarrageRenderer提供的时间，也就是外部时间。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BarrageDispatcher.m</span></div><div class="line">- (<span class="keyword">void</span>)activeSprite:(BarrageSprite *)sprite</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.delegate &amp;&amp; [<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(willActiveSprite:)]) &#123;</div><div class="line">        [<span class="keyword">self</span>.delegate willActiveSprite:sprite];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>激活弹幕的操作涉及到添加弹幕view和弹幕定位，这并不是<code>BarrageDispatcher</code>的职责。<br>所以将操作交给代理，这里的代理就是<code>BarrageRenderer</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BarrageRenderer.m</span></div><div class="line">- (<span class="keyword">void</span>)willActiveSprite:(BarrageSprite *)sprite</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSValue</span> * value = [<span class="built_in">NSValue</span> valueWithCGRect:_canvas.bounds];</div><div class="line">    [_context setObject:value forKey:kBarrageRendererContextCanvasBounds];</div><div class="line"></div><div class="line">    <span class="built_in">NSArray</span> * itemMap = [_spriteClassMap objectForKey:<span class="built_in">NSStringFromClass</span>([sprite <span class="keyword">class</span>])];</div><div class="line">    <span class="keyword">if</span> (itemMap) &#123;</div><div class="line">        [_context setObject:[itemMap <span class="keyword">copy</span>] forKey:kBarrageRendererContextRelatedSpirts];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    [_context setObject:@(_time) forKey:kBarrageRendererContextTimestamp];</div><div class="line"></div><div class="line">    <span class="built_in">NSInteger</span> index = [<span class="keyword">self</span> viewIndexOfSprite:sprite];</div><div class="line"></div><div class="line">    [sprite activeWithContext:_context];</div><div class="line">    [<span class="keyword">self</span> indexAddSprite:sprite];</div><div class="line">    [_canvas insertSubview:sprite.view atIndex:index];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>willActiveSprite</code>方法获取当前的<code>_context</code>，将<code>_context</code>传给<code>BarrageSprite</code>，<br>由<code>BarrageSprite</code>根据当前的<code>_context</code>调用<code>activeWithContext</code>对自己进行激活。<br>然后将<code>BarrageSprite</code>对应的<code>_view</code>添加到<code>_canvas</code>中，完成弹幕的激活。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BarrageSprite.m</span></div><div class="line">- (<span class="keyword">void</span>)activeWithContext:(<span class="built_in">NSDictionary</span> *)context</div><div class="line">&#123;</div><div class="line">    <span class="built_in">CGRect</span> rect = [[context objectForKey:kBarrageRendererContextCanvasBounds]<span class="built_in">CGRectValue</span>];</div><div class="line">    <span class="built_in">NSArray</span> * sprites = [context objectForKey:kBarrageRendererContextRelatedSpirts];</div><div class="line">    <span class="built_in">NSTimeInterval</span> timestamp = [[context objectForKey:kBarrageRendererContextTimestamp]doubleValue];</div><div class="line">    _timestamp = timestamp;</div><div class="line">    _view = [<span class="keyword">self</span> bindingView];</div><div class="line">    [<span class="keyword">self</span> configView];</div><div class="line">    [_view sizeToFit];</div><div class="line">    <span class="keyword">if</span> (!<span class="built_in">CGSizeEqualToSize</span>(_mandatorySize, <span class="built_in">CGSizeZero</span>)) &#123;</div><div class="line">        _view.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, _mandatorySize.width, _mandatorySize.height);</div><div class="line">    &#125;</div><div class="line">    _origin = [<span class="keyword">self</span> originInBounds:rect withSprites:sprites];</div><div class="line">    _view.frame = <span class="built_in">CGRectMake</span>(_origin.x, _origin.y, <span class="keyword">self</span>.size.width, <span class="keyword">self</span>.size.height);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在<code>BarrageSprite</code>的激活方法中，首先从<code>_context</code>中拿取当前对参数。<br>然后调用<code>bindingView</code>方法生成<code>BarrageSprite</code>对应对<code>_view</code>，<br>使用c<code>onfigView</code>方法根据B<code>arrageSprite</code>修改<code>_view</code>状态。<br>然后调用<code>originInBounds:withSprites:</code>方法计算弹幕<code>_view</code>的初始位置。<br>根据初始位置设置<code>_view</code>的<code>frame</code>.</p>
<p>BarrageSprite的<code>bindingView</code>和<code>originInBounds:withSprites:</code>的实现都是一个很简单的不能使用的实现。<br>在子类中才会给出合适的实现。<code>BarrageSprite</code>对应与C++或者Java中的抽象类。<br>但是Objective-C没有抽象类的机制，所以会在看代码时有些不清晰。</p>
<p>至此一个弹幕从添加到激活的步骤已经走完，接下来每一帧弹幕的位置会进行更新，知道弹幕失效。</p>
<h2 id="弹幕的位置更新过程"><a href="#弹幕的位置更新过程" class="headerlink" title="弹幕的位置更新过程"></a>弹幕的位置更新过程</h2><p>上面提到过，每一帧更新对方法是<code>BarrageRenderer</code>中的<code>update</code>方法。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BarrageRenderer.m</span></div><div class="line">- (<span class="keyword">void</span>)update</div><div class="line">&#123;</div><div class="line">    [_dispatcher dispatchSprites]; <span class="comment">// 对弹幕的状态进行判断。</span></div><div class="line">    <span class="keyword">for</span> (BarrageSprite * sprite <span class="keyword">in</span> _dispatcher.activeSprites) &#123;</div><div class="line">        [sprite updateWithTime:_time];  <span class="comment">// 对激活弹幕的位置进行更新</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法会遍历激活状态对弹幕，并调用BarrageSprite的<code>updateWithTime:</code>方法。<br>方法参数的时间是BarrageClock提供的时间，也就是逻辑时间。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)updateWithTime:(<span class="built_in">NSTimeInterval</span>)time</div><div class="line">&#123;</div><div class="line">    _valid = [<span class="keyword">self</span> validWithTime:time];</div><div class="line">    _view.frame = [<span class="keyword">self</span> rectWithTime:time];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先根据时间计算弹幕是否有效，将结果存储在<code>_valid</code>中，供下一帧<code>BarrageDispatcher</code>使用。<br>然后计算这一帧弹幕应该在的位置，存储在<code>_view.frame</code>中，实现弹幕位置的变化。</p>
<h2 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h2><p>这个弹幕库的功能实现的功能非常多。<br>失效弹幕的重新激活，z-index功能，弹幕的记录等等。<br>这导致整体的功能比较复杂，在实际使用的时候建议进行裁减和定制。</p>
<p>一个突出的点是，为了支持弹幕类型的扩展性，弹幕的定位实现在了具体类型的弹幕中，<br>需要将所有同类弹幕信息传入BarrageSprite中，增加了代码的复杂度。</p>
<p>弹幕库对限流的支持不够充分。目前仅仅能根据弹幕整体数量进行限流，<br>而不能根据具体弹幕类型进行限流。因为BarrageDispatcher不了解具体弹幕的信息。</p>
<p>如果只需要支持固定类型的弹幕，可以将定位功能实现在BarrageDispatcher中，减小代码复杂度。<br>同时可以实现精准地限流。</p>
<p>当前的功能只支持弹幕的渲染，没有实现点击，手势的交互。<br>这个功能可以在BarrageCanvas中实现，然后做碰撞检测找到具体的弹幕实现功能。</p>
<!--  comment tag  -->

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/01/seu-red-package/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Jilong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘怜苏">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/01/seu-red-package/" itemprop="url">东大跨年红包记--并发案例分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-01T20:23:00+08:00">
                2017-01-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>2016年12月31日晚，东南大学在九龙湖体育馆举办跨年演唱会。演唱会期间送出了3000个现金红包，同时抢红包的人数在4000人左右。抢红包的流程和编码主要由我负责实现。在这样一个并发环境下，虽然所有的红包都送了出去，但是也暴露出一些问题。就实际情况和出现的问题，做个分析与总结。一是记录这个经历，二来寄希望这些经验能对其他人有所助益。</p>
<p>达人荟接到跨年红包的工作时，团队中有并发经验的孙越没有时间做这个事情，因而开发的工作交给我了。我在这个时候没有前端和后台开发经验，对并发量也没有清晰的认识，实现抢红包的时间限制（十天）也很紧张。幸运的是，有李盼辉孙越这些同伴们一同讨论解决问题，我们按时完成了开发，经过了几轮测试，流程与逻辑上确定没有问题。做了压力测试，并发量能满足现场的人数。但是，<strong>压力测试很难完全模拟实际情况，压力测试的结果只能作为参考而不能作为判断的依据。</strong></p>
<hr>
<p>抢红包的工作流程如下图所示：<br><img src="http://upload-images.jianshu.io/upload_images/2448550-bd13b82859920238.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>代码分四个部分</p>
<ol>
<li>抢红包前端网页</li>
<li>入口服务器(Python进程)：通知网页是否跳转到抢红包页面</li>
<li>红包服务器(Python进程)：接受抢红包请求，与微信红包服务器交互发红包</li>
<li>管理员界面程序：发送开始抢红包命令，定时（1s）拉取服务器状态在界面上展示</li>
</ol>
<p>正常的工作流程：</p>
<ol>
<li>终端开始加载网页<font color="red">(1)</font>,向入口服务器询问入口是否开放<font color="red">(3)</font></li>
<li>管理员向入口服务器和红包服务器发送开始抢红包的命令<font color="red">(2)</font></li>
<li>终端网页进入抢红包页面，向红包服务器发红包请求<font color="red">(4)</font></li>
<li>红包服务器判断通过后，调用微信红包接口，发放红包<font color="red">(5)</font></li>
<li>管理员界面会定时向入口服务器和红包服务器发请求获取服务器状态<font color="red">(6)</font></li>
</ol>
<p>在这样的流程中，针对较高的并发量，我们做了以下考虑：</p>
<ol>
<li>主要的网络请求是入口查询请求和抢红包请求。将这两个请求分开处理并部署在两台主机上。</li>
<li>为前端的静态资源设置了缓存一天，避免重复下载图片。</li>
<li>对微信红包服务器的请求<font color="red">(5)</font>做了异步</li>
<li>管理员页面定时更新服务器状态，及时发现问题。</li>
</ol>
<hr>
<p>现场的实际情况是这样的：</p>
<p>观众视角：</p>
<p>主持人宣布开始倒计时，点击进入网页，网页特别卡，一直加载中，白屏。有人一直等着，有人放弃了。过了一会发现不那么卡了，进去开始抢红包，抢到了/没抢到。</p>
<p>我的视角：</p>
<p>主持人宣布开始倒计时，我点下了开始按钮，将开始抢红包的请求发送给服务器。此时周围不停地传来网页打不开的声音，我的管理界面也卡死了，不再刷新服务器的状态。</p>
<p>怀疑入口服务器崩溃了，进而联想到所有人都不能进入抢红包页面，这意味着抢红包程序的彻底失效。高压状态下的异常情况导致失去了正常的判断力。唯一能做的就是在一个卡死的界面上点击开始按钮而不确定到底发生了什么。过了一段时间，周围开始传出来红包抢到了的消息。</p>
<p>这时我也基本恢复了判断力，和李盼辉一起确认当前的状态。进入服务器发现后台正常，第一轮红包已经发送完毕。回头看管理界面程序，管理界面程序已经恢复正常，显示红包已经发送完毕。我们检查一遍代码逻辑，没有发现问题，只能暂时归结为网络请求抛出了异常。判断管理界面不可靠，将开始抢红包的请求从界面程序里抽取出来，下一轮用命令行发送开始请求。</p>
<hr>
<p>活动结束后，看日志发现：第一轮红包时，入口服务器平均每秒钟收到40个请求，平均每个请求的处理时间是1ms。入口服务器并没有满负荷跑，现场发出的请求个数也肯定多于40个每秒，那么请求就某个地方阻塞了。</p>
<p>回看服务器的部署，前端网页和入口服务器部署在一台主机上，网页里的所有图片也都从这台主机获取！而且加载网页和发请求是串行的。网页加载完毕才会发出请求。</p>
<p>静态资源的缓存在第一波抢红包中没有起到任何作用，因为大多数观众是第一次打开网页。网页里所有的内容都要全部加载一遍。HTML文档的数据量小于1KB，而所有图片的大小共500KB，全场4000人，同时抢红包的人数算2000人，一共1GB的数据量需要从主机传输出去。那个时刻的网络非常的繁忙。</p>
<p>观众手机获取不了网页的背景图，网页自然是白屏的。管理员的界面程序在如此繁忙的网络环境下拉取服务器状态，自然会阻塞超时。界面程序只有一个后台线程进行网络请求，阻塞之后，主线程的界面没有数据来源自然会卡死，获取不到两个服务器的状态，导致管理员出现对服务器状态不确定不可控的状态。</p>
<p>对于高并发的情况，需要注意：<strong>每个网络请求都要考虑执行时间，如果这个请求阻塞了会有多大的影响？</strong>在我的控制界面程序中，单后台线程一旦阻塞，所有的网络请求都玩完，界面卡死，控制程序失效。这类漏洞，平时测试是发现不了的，只会在并发环境下体现出来。</p>
<p>找到原因后，解决办法也很简单，把图片等静态资源托管到第三方服务器。对于每个用户，500KB的图片从第三方主机获取，我们的主机只负责不到1KB的HTML和接口数据。在跨年之前测试的入口服务器的并发量是每秒600次请求。如果没有图片流量，服务器完全能应付这样的并发量。</p>
<p>事实就是这么的简单，直接。过多的图片数据把主机网络堵塞了。</p>
<p>因为缓存，忽略了这些图片。因为这些图片导致了网页的卡卡卡。只需要做很少的工作就能把卡卡卡消灭，而我却没有意识到。<strong>编码工作培养的是对数据状态的敏感度，比如数据库，多线程同步，异常等等。而并发状态下还需要对机器的网络状态敏感，主机需要通过网络发送哪些数据，可能的网络状态是什么，堵塞还是畅通。</strong>这个教训我会记住的。</p>
<p>总结一下，这些经验需要记住：</p>
<ol>
<li><strong>压力测试要尽可能模拟真实的情况，测试结果才能作为参考依据。</strong></li>
<li><strong>合理处理好图片等静态资源，静态资源的大小会远大于路由请求的数据量。</strong></li>
<li><strong>每个网络请求都要考虑执行时间，如果这个请求超时了会有多大的影响？</strong></li>
<li><strong>编码工作培养的是对数据状态的敏感度，比如数据库，多线程同步，异常等等。而并发状态下还需要对机器的网络状态敏感，主机需要通过网络发送哪些数据，可能的网络状态是什么，堵塞还是畅通。</strong></li>
</ol>
<p>令人开心的是：除了图片流量导致的卡卡卡之外，程序运行一切正常。卡卡卡之后所有红包发送完毕。代码我已经托管在<a href="https://github.com/mutexliu/WeiXinRedPackage" target="_blank" rel="external">Github</a>上，有类似微信红包开发需求的可以参考。</p>
<p>最后，感谢达人荟的各位小伙伴们，跟你们一起做事很开心。感谢东南大学跨年晚会和达人荟给了我这样一个深刻又难以忘记的跨年夜。这样度过在东大的第七个也是最后一个跨年夜，真是一番奇妙的经历。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/21/android-savestate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Jilong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘怜苏">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/21/android-savestate/" itemprop="url">Android中SaveState原理分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-21T18:02:18+08:00">
                2016-08-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在Activity被回收之前，系统会调用<code>Activity#onSaveInstanceState(Bundle outState)</code>来保存View的状态到传入的<code>outState</code>对象中。<br>在Activity被重新创建时，<code>Activity#onCreate(Bundle savedInstanceState)</code>和<code>Activity#onRestoreInstanceState(Bundle savedInstanceState)</code>会传入保存的状态信息并恢复View的状态。<br>用户也可以重载<code>Activity#onSaveInstanceState()</code>方法来保存额外的Activity状态，并在<code>Activity.onCreate()</code>或者<code>Activity#onRestoreInstanceState（）</code>获取这些状态。<br>这里主要看View的状态是怎么保存和重新获取的。</p>
<p>先说一下Bundle类，在Android代码里的注释是：<br>A mapping from String values to various Parcelable types.<br>可以简单把Bundle看成一个Map<string, object="">，其中Object都实现了Parcelable接口。Bundle类有一系列的set和get方法用来操作Map中的值。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(Bundle outState)</span> </span>&#123;</div><div class="line">    outState.putBundle(WINDOW_HIERARCHY_TAG, mWindow.saveHierarchyState());</div><div class="line">    Parcelable p = mFragments.saveAllState();</div><div class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</div><div class="line">        outState.putParcelable(FRAGMENTS_TAG, p);</div><div class="line">    &#125;</div><div class="line">    getApplication().dispatchActivitySaveInstanceState(<span class="keyword">this</span>, outState);</div><div class="line">&#125;</div></pre></td></tr></table></figure></string,></p>
<p>这个方法做了三件事，1.保存Activity对应的Window的State信息，并存放在outState中，2.保存所有Fragements的信息，如果不为零，也存放在outState中，3.调用外部注册的一些回调方法。保存Fragments的信息是通过保存Fragment的根View的状态实现的，这和保存Window的State信息类似。所以看<code>mWindow.saveHierarchyState()</code>方法，这里mWindow是一个PhoneWindow对象，找到<code>PhoneWindow#saveHierarchyState()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Bundle <span class="title">saveHierarchyState</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//step 1:</span></div><div class="line">    Bundle outState = <span class="keyword">new</span> Bundle();</div><div class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> outState;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// step 2: save View states</span></div><div class="line">    SparseArray&lt;Parcelable&gt; states = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</div><div class="line">    mContentParent.saveHierarchyState(states);</div><div class="line">    outState.putSparseParcelableArray(VIEWS_TAG, states);</div><div class="line"></div><div class="line">    <span class="comment">// step 3: save the focused view id</span></div><div class="line">    View focusedView = mContentParent.findFocus();</div><div class="line">    <span class="keyword">if</span> (focusedView != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (focusedView.getId() != View.NO_ID) &#123;</div><div class="line">            outState.putInt(FOCUSED_ID_TAG, focusedView.getId());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">                Log.d(TAG, <span class="string">"couldn't save which view has focus because the focused view "</span></div><div class="line">                        + focusedView + <span class="string">" has no id."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// step 4: save the panels state</span></div><div class="line">    SparseArray&lt;Parcelable&gt; panelStates = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</div><div class="line">    savePanelState(panelStates);</div><div class="line">    <span class="keyword">if</span> (panelStates.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        outState.putSparseParcelableArray(PANELS_TAG, panelStates);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// step 5: save actionBar state</span></div><div class="line">    <span class="keyword">if</span> (mDecorContentParent != <span class="keyword">null</span>) &#123;</div><div class="line">        SparseArray&lt;Parcelable&gt; actionBarStates = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</div><div class="line">        mDecorContentParent.saveToolbarHierarchyState(actionBarStates);</div><div class="line">        outState.putSparseParcelableArray(ACTION_BAR_TAG, actionBarStates);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> outState;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法依次做了这些事情：<br>1.创建Bundle对象用来返回，判断Window是否有对应的mContentParent这个View对象，如果没有直接返回<br>2.保存View的信息<br>3.保存当前View焦点的信息<br>4.保存抽屉信息<br>5.保存ActionBar信息。<br>我们关注第二步保存View信息: <code>mContentParent.saveHierarchyState(states);</code>.这里<code>states</code>是一个<code>SparseArray&lt;Parcelable&gt;</code>对象，所有View信息都会保存在<code>states</code>中。<code>SparseArray</code>可以理解为Map<integer,object>,是Android系统为了优化内存创建的类。<br>看一下<code>View#saveHierarchyState(SparseArray&lt;Parcelable&gt; container)</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveHierarchyState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</div><div class="line">    dispatchSaveInstanceState(container);</div><div class="line">&#125;</div></pre></td></tr></table></figure></integer,object></p>
<p>直接调用了<code>View#dispatchSaveInstanceState(SparseArray&lt;Parcelable&gt; container)</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mID != NO_ID &amp;&amp; (mViewFlags &amp; SAVE_DISABLED_MASK) == <span class="number">0</span>) &#123;</div><div class="line">        mPrivateFlags &amp;= ~PFLAG_SAVE_STATE_CALLED;</div><div class="line">        Parcelable state = onSaveInstanceState();</div><div class="line">        <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_SAVE_STATE_CALLED) == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">                    <span class="string">"Derived class did not call super.onSaveInstanceState()"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Log.i("View", "Freezing #" + Integer.toHexString(mID)</span></div><div class="line">            <span class="comment">// + ": " + state);</span></div><div class="line">            container.put(mID, state);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>检查一下View是否设置了ID，如果没有id直接返回。这里我们可以看到，如果View没有设置id，是不会保存它的状态的。设置了ID之后，获取状态，并将状态以ID为key存储在<code>SparseArray</code>中。这里可以看出，如果View树中两个View的id相同，那么后一个View的<code>SavedState</code>会覆盖前一个<code>SavedState</code>。当然这种情况下<code>findViewById()</code>也会出问题。<br>保存View状态是在<code>onSaveInstanceState()</code>中实现的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Parcelable <span class="title">onSaveInstanceState</span><span class="params">()</span> </span>&#123;</div><div class="line">    mPrivateFlags |= PFLAG_SAVE_STATE_CALLED;</div><div class="line">    <span class="keyword">if</span> (mStartActivityRequestWho != <span class="keyword">null</span>) &#123;</div><div class="line">        BaseSavedState state = <span class="keyword">new</span> BaseSavedState(AbsSavedState.EMPTY_STATE);</div><div class="line">        state.mStartActivityRequestWhoSaved = mStartActivityRequestWho;</div><div class="line">        <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> BaseSavedState.EMPTY_STATE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法检查了一下<code>mStartActivityRequestWho</code>这个String对象是否为null，<code>mStartActivityRequestWho</code>这个对象只有在调用了<code>View#startActivityForResult</code>时才会设置，这时标记一下state中的状态，为null时，直接返回一个空状态。<br>在View类中保存状态里用了三个方法，其中<code>saveHierachyState()</code>方法直接传递给了<code>dispatchSaveInstanceState()</code>方法。<code>dispatchSaveInstanceState()</code>用来分发保存状态的行为，这个方法的默认行为是在有ID的情况下保存自身的state，没有id的情况下什么都不做。所以ViewGroup可以选择重写这个方法，将保存状态的行为分发到子类中。<code>onSaveInstanceState()</code>方法用来具体地保存当前View的状态，自定义View可以选择重写这个方法。</p>
<p>看一下<code>ViewGroup#dispatchSaveInstanceState()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.dispatchSaveInstanceState(container);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = mChildrenCount;</div><div class="line">    <span class="keyword">final</span> View[] children = mChildren;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        View c = children[i];</div><div class="line">        <span class="keyword">if</span> ((c.mViewFlags &amp; PARENT_SAVE_DISABLED_MASK) != PARENT_SAVE_DISABLED) &#123;</div><div class="line">            c.dispatchSaveInstanceState(container);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先调用<code>View#dispatchSaveInstanceState()</code>保存自身的状态，然后遍历子View，调用对应的<code>dispatchSaveInstanceState()</code>方法，这里实现的View树的遍历。<br>看一下<code>TextView#onSaveInstanceState()</code>是怎么保存状态的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Parcelable <span class="title">onSaveInstanceState</span><span class="params">()</span> </span>&#123;</div><div class="line">       Parcelable superState = <span class="keyword">super</span>.onSaveInstanceState();</div><div class="line"></div><div class="line">       <span class="comment">// Save state if we are forced to</span></div><div class="line">       <span class="keyword">boolean</span> save = mFreezesText;</div><div class="line">       <span class="keyword">int</span> start = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> end = <span class="number">0</span>;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (mText != <span class="keyword">null</span>) &#123;</div><div class="line">           start = getSelectionStart();</div><div class="line">           end = getSelectionEnd();</div><div class="line">           <span class="keyword">if</span> (start &gt;= <span class="number">0</span> || end &gt;= <span class="number">0</span>) &#123;</div><div class="line">               <span class="comment">// Or save state if there is a selection</span></div><div class="line">               save = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (save) &#123;</div><div class="line">           SavedState ss = <span class="keyword">new</span> SavedState(superState);</div><div class="line">           <span class="comment">// XXX Should also save the current scroll position!</span></div><div class="line">           ss.selStart = start;</div><div class="line">           ss.selEnd = end;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (mText <span class="keyword">instanceof</span> Spanned) &#123;</div><div class="line">               Spannable sp = <span class="keyword">new</span> SpannableStringBuilder(mText);</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (mEditor != <span class="keyword">null</span>) &#123;</div><div class="line">                   removeMisspelledSpans(sp);</div><div class="line">                   sp.removeSpan(mEditor.mSuggestionRangeSpan);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               ss.text = sp;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               ss.text = mText.toString();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (isFocused() &amp;&amp; start &gt;= <span class="number">0</span> &amp;&amp; end &gt;= <span class="number">0</span>) &#123;</div><div class="line">               ss.frozenWithFocus = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           ss.error = getError();</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (mEditor != <span class="keyword">null</span>) &#123;</div><div class="line">               ss.editorState = mEditor.saveInstanceState();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> ss;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> superState;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>首先判断TextView是否需要保存状态，如果mFreezesText设置为true，或者TextView处于被选中的状态，那么需要保存状态。不许要保存保存状态的话直接返回<code>super.onSaveInstanceState()</code>.<br>TextView中有个内部类SavedState用来表示状态，将对应的状态设置好之后直接返回即可。</p>
<p>至此，整个保存状态的过程已经走完，总结一下：<br>1.在Activity被回收时，会触发一个SaveState的事件。<br>2.跟其他的事件一样，SaveState事件从Activity-&gt;Window-&gt;View传递到最大的View，然后遍历View树保存状态<br>3.状态保存在一个SparseArray中，以View的ID作为key。<br>4.自定义View可以重载<code>onSaveInstanceState()</code>来保存自己的状态，参考TextView的实现方法。<br>5.</p>
<p>Restore的过程：<code>Activity#onRestoreInstanceState()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mWindow != <span class="keyword">null</span>) &#123;</div><div class="line">        Bundle windowState = savedInstanceState.getBundle(WINDOW_HIERARCHY_TAG);</div><div class="line">        <span class="keyword">if</span> (windowState != <span class="keyword">null</span>) &#123;</div><div class="line">            mWindow.restoreHierarchyState(windowState);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>跟保存的过程一样，传递到<code>Window#restoreHierarchyState()</code>方法中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreHierarchyState</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="comment">// step 1.</span></div><div class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// step 2.</span></div><div class="line">    SparseArray&lt;Parcelable&gt; savedStates</div><div class="line">            = savedInstanceState.getSparseParcelableArray(VIEWS_TAG);</div><div class="line">    <span class="keyword">if</span> (savedStates != <span class="keyword">null</span>) &#123;</div><div class="line">        mContentParent.restoreHierarchyState(savedStates);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// step 3. restore the focused view</span></div><div class="line">    <span class="keyword">int</span> focusedViewId = savedInstanceState.getInt(FOCUSED_ID_TAG, View.NO_ID);</div><div class="line">    <span class="keyword">if</span> (focusedViewId != View.NO_ID) &#123;</div><div class="line">        View needsFocus = mContentParent.findViewById(focusedViewId);</div><div class="line">        <span class="keyword">if</span> (needsFocus != <span class="keyword">null</span>) &#123;</div><div class="line">            needsFocus.requestFocus();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Log.w(TAG,</div><div class="line">                    <span class="string">"Previously focused view reported id "</span> + focusedViewId</div><div class="line">                            + <span class="string">" during save, but can't be found during restore."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// step 4. restore the panels</span></div><div class="line">    SparseArray&lt;Parcelable&gt; panelStates = savedInstanceState.getSparseParcelableArray(PANELS_TAG);</div><div class="line">    <span class="keyword">if</span> (panelStates != <span class="keyword">null</span>) &#123;</div><div class="line">        restorePanelState(panelStates);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// step 5.</span></div><div class="line">    <span class="keyword">if</span> (mDecorContentParent != <span class="keyword">null</span>) &#123;</div><div class="line">        SparseArray&lt;Parcelable&gt; actionBarStates =</div><div class="line">                savedInstanceState.getSparseParcelableArray(ACTION_BAR_TAG);</div><div class="line">        <span class="keyword">if</span> (actionBarStates != <span class="keyword">null</span>) &#123;</div><div class="line">            doPendingInvalidatePanelMenu();</div><div class="line">            mDecorContentParent.restoreToolbarHierarchyState(actionBarStates);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Log.w(TAG, <span class="string">"Missing saved instance states for action bar views! "</span> +</div><div class="line">                    <span class="string">"State will not be restored."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>跟保存的过程完全一致，分五步。我们只看第三步：<code>mContentParent.restoreHierarchyState(savedStates)</code>,这里调用<code>View#restoreHierarchyState(savedStates)</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreHierarchyState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</div><div class="line">    dispatchRestoreInstanceState(container);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>一样直接传递到<code>View#dispatchRestoreInstanceState()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchRestoreInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mID != NO_ID) &#123;</div><div class="line">        Parcelable state = container.get(mID);</div><div class="line">        <span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Log.i("View", "Restoreing #" + Integer.toHexString(mID)</span></div><div class="line">            <span class="comment">// + ": " + state);</span></div><div class="line">            mPrivateFlags &amp;= ~PFLAG_SAVE_STATE_CALLED;</div><div class="line">            onRestoreInstanceState(state);</div><div class="line">            <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_SAVE_STATE_CALLED) == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">                        <span class="string">"Derived class did not call super.onRestoreInstanceState()"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对于View的这个方法，从SparseArray中用mID获取到state，<br>然后调用<code>View#onRestoreInstanceState()</code>方法。看一下ViewGroup对应的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchRestoreInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.dispatchRestoreInstanceState(container);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = mChildrenCount;</div><div class="line">    <span class="keyword">final</span> View[] children = mChildren;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        View c = children[i];</div><div class="line">        <span class="keyword">if</span> ((c.mViewFlags &amp; PARENT_SAVE_DISABLED_MASK) != PARENT_SAVE_DISABLED) &#123;</div><div class="line">            c.dispatchRestoreInstanceState(container);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>先调用View版本的<code>dispatchRestoreInstanceState()</code>方法，然后遍历childView,调用对应的<code>dispatchRestoreInstanceState()</code>方法。<br>最后看一下<code>View#onRestoreInstanceState()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Parcelable state)</span> </span>&#123;</div><div class="line">    mPrivateFlags |= PFLAG_SAVE_STATE_CALLED;</div><div class="line">    <span class="keyword">if</span> (state != <span class="keyword">null</span> &amp;&amp; !(state <span class="keyword">instanceof</span> AbsSavedState)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Wrong state class, expecting View State "</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (state != <span class="keyword">null</span> &amp;&amp; state <span class="keyword">instanceof</span> BaseSavedState) &#123;</div><div class="line">        mStartActivityRequestWho = ((BaseSavedState) state).mStartActivityRequestWhoSaved;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法很简单，直接获取mStartActivityRequestWho对象，对于自定义View，需要重写这个方法，获取自己的状态。同样看一下<code>TextView#onRestoreInstanceState()</code>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Parcelable state)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!(state <span class="keyword">instanceof</span> SavedState)) &#123;</div><div class="line">        <span class="keyword">super</span>.onRestoreInstanceState(state);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SavedState ss = (SavedState)state;</div><div class="line">    <span class="keyword">super</span>.onRestoreInstanceState(ss.getSuperState());</div><div class="line"></div><div class="line">    <span class="comment">// XXX restore buffer type too, as well as lots of other stuff</span></div><div class="line">    <span class="keyword">if</span> (ss.text != <span class="keyword">null</span>) &#123;</div><div class="line">        setText(ss.text);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ss.selStart &gt;= <span class="number">0</span> &amp;&amp; ss.selEnd &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (mText <span class="keyword">instanceof</span> Spannable) &#123;</div><div class="line">            <span class="keyword">int</span> len = mText.length();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (ss.selStart &gt; len || ss.selEnd &gt; len) &#123;</div><div class="line">                String restored = <span class="string">""</span>;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (ss.text != <span class="keyword">null</span>) &#123;</div><div class="line">                    restored = <span class="string">"(restored) "</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Log.e(LOG_TAG, <span class="string">"Saved cursor position "</span> + ss.selStart +</div><div class="line">                      <span class="string">"/"</span> + ss.selEnd + <span class="string">" out of range for "</span> + restored +</div><div class="line">                      <span class="string">"text "</span> + mText);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                Selection.setSelection((Spannable) mText, ss.selStart, ss.selEnd);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (ss.frozenWithFocus) &#123;</div><div class="line">                    createEditorIfNeeded();</div><div class="line">                    mEditor.mFrozenWithFocus = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ss.error != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> CharSequence error = ss.error;</div><div class="line">        <span class="comment">// Display the error later, after the first layout pass</span></div><div class="line">        post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mEditor == <span class="keyword">null</span> || !mEditor.mErrorWasChanged) &#123;</div><div class="line">                    setError(error);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ss.editorState != <span class="keyword">null</span>) &#123;</div><div class="line">        createEditorIfNeeded();</div><div class="line">        mEditor.restoreInstanceState(ss.editorState);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先判断state是否为TextView保存的状态，如果不是，直接调用super，然后获取对应的状态设置给TextView。</p>
<p>可以看出Restore过程和Save过程完全相同。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/20/android-view-draw/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Jilong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘怜苏">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/20/android-view-draw/" itemprop="url">Android中View的绘制流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-20T14:02:23+08:00">
                2016-08-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>Android</code>的<code>View</code>绘制是从根节点（<code>Activity</code>对应的根节点是<code>DecorView</code>）开始，他是一个自上而下的过程。View的绘制经历三个过程：measure、layout、draw。<br>measure过程从<code>View</code>的<code>measure()</code>方法看起：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="comment">// Suppress sign extension for the low bytes</span></div><div class="line">    <span class="keyword">long</span> key = (<span class="keyword">long</span>) widthMeasureSpec &lt;&lt; <span class="number">32</span> | (<span class="keyword">long</span>) heightMeasureSpec &amp; <span class="number">0xffffffffL</span>;</div><div class="line">    <span class="comment">//生成缓存的key</span></div><div class="line">    <span class="keyword">if</span> (mMeasureCache == <span class="keyword">null</span>) mMeasureCache = <span class="keyword">new</span> LongSparseLongArray(<span class="number">2</span>); <span class="comment">// 创建缓存</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||</div><div class="line">            widthMeasureSpec != mOldWidthMeasureSpec ||</div><div class="line">            heightMeasureSpec != mOldHeightMeasureSpec) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// first clears the measured dimension flag</span></div><div class="line">        mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> cacheIndex = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ? -<span class="number">1</span> :</div><div class="line">                mMeasureCache.indexOfKey(key);</div><div class="line">        <span class="keyword">if</span> (cacheIndex &lt; <span class="number">0</span> || sIgnoreMeasureCache) &#123;</div><div class="line">            <span class="comment">// measure ourselves, this should set the measured dimension flag back</span></div><div class="line">            onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">            mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">long</span> value = mMeasureCache.valueAt(cacheIndex);</div><div class="line">            <span class="comment">// Casting a long to int drops the high 32 bits, no mask needed</span></div><div class="line">            setMeasuredDimensionRaw((<span class="keyword">int</span>) (value &gt;&gt; <span class="number">32</span>), (<span class="keyword">int</span>) value);</div><div class="line">            mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// flag not set, setMeasuredDimension() was not invoked, we raise</span></div><div class="line">        <span class="comment">// an exception to warn the developer</span></div><div class="line">        <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_MEASURED_DIMENSION_SET) != PFLAG_MEASURED_DIMENSION_SET) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"View with id "</span> + getId() + <span class="string">": "</span></div><div class="line">                    + getClass().getName() + <span class="string">"#onMeasure() did not set the"</span></div><div class="line">                    + <span class="string">" measured dimension by calling"</span></div><div class="line">                    + <span class="string">" setMeasuredDimension()"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mOldWidthMeasureSpec = widthMeasureSpec;</div><div class="line">    mOldHeightMeasureSpec = heightMeasureSpec;</div><div class="line"></div><div class="line">    mMeasureCache.put(key, ((<span class="keyword">long</span>) mMeasuredWidth) &lt;&lt; <span class="number">32</span> |</div><div class="line">            (<span class="keyword">long</span>) mMeasuredHeight &amp; <span class="number">0xffffffffL</span>); <span class="comment">// suppress sign extension</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在代码中<code>mMeasureCache</code>是一个<code>LongSparseLongArray</code>，代表measure结果的缓存，如果缓存没有命中或者忽略缓存，就调用<code>onMeasure</code>来测量结果，这种情况下用户需要调用<code>setMeasuredDimension()</code>来设置measure的结果，相反情况下直接使用缓存的结果，并直接调用<code>setMeasuredDimensionraw()</code>设置测量结果。最后将得到的结果保存在缓存中。</p>
<p>然后看<code>View</code>的<code>onMeasure()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用<code>getDefaultSize()</code>方法计算出默认的值，具体的计算方法读者可以自行研究一下，在自定义<code>View</code>时可以参考。</p>
<p><code>View</code>的<code>measure()</code>方法的功能是确定自己的大小，而<code>ViewGroup</code>的<code>measure()</code>方法则需要确定自己和所有的子<code>View</code>的大小。在<code>ViewGroup</code>中并没有找到<code>measure()</code>和<code>onMeasure()</code>方法，因为<code>measure()</code>方法对于所有的<code>View</code>都是通用的，只需要重写<code>onMeasure()</code>方法，同时不同的<code>ViewGroup</code>计算大小的方法并不相同，所以需要具体的<code>ViewGroup</code>来重写<code>onMeasure()</code>方法。<br><code>ViewGroup</code>提供了三个measure相关的方法：<code>measureChild</code>,<code>measureChildren</code>,<code>measureChildWithMargins</code>供继承者调用。<br>我们选择最简单的一个<code>ViewGroup</code>,<code>FrameLayout</code>来看一下<code>onMeasure()</code>的实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> count = getChildCount();</div><div class="line">    <span class="keyword">int</span> maxHeight = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> maxWidth = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> childState = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        <span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">        <span class="keyword">if</span> (mMeasureAllChildren || child.getVisibility() != GONE) &#123;</div><div class="line">            measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);</div><div class="line">            <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">            maxWidth = Math.max(maxWidth,</div><div class="line">                    child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);</div><div class="line">            maxHeight = Math.max(maxHeight,</div><div class="line">                    child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);</div><div class="line">            childState = combineMeasuredStates(childState, child.getMeasuredState());</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Account for padding too</span></div><div class="line">    maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground();</div><div class="line">    maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">    <span class="comment">// Check against our minimum height and width</span></div><div class="line">    maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight());</div><div class="line">    maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</div><div class="line"></div><div class="line">    <span class="comment">// some more code</span></div><div class="line">    setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</div><div class="line">            resolveSizeAndState(maxHeight, heightMeasureSpec,</div><div class="line">                    childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));</div><div class="line">    <span class="comment">// some more code</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>遍历所有的child，调用child的<code>measure()</code>方法获取child的宽和高。分别选取最大的宽和高，与自己的最小值比较，得到最后自己的大小，调用<code>setMeasuredDimension()</code>设置自己的大小。<br>PS：childView的measure方法可能会调用多次。</p>
<p>通过这一系列的<code>measure()</code>方法的调用，整个View层级的大小已经设置好了，接下来进入layout过程:<br>View的layout()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</div><div class="line">        onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</div><div class="line">        mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> oldL = mLeft;</div><div class="line">    <span class="keyword">int</span> oldT = mTop;</div><div class="line">    <span class="keyword">int</span> oldB = mBottom;</div><div class="line">    <span class="keyword">int</span> oldR = mRight;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</div><div class="line">            setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</div><div class="line">        onLayout(changed, l, t, r, b);</div><div class="line">        mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</div><div class="line"></div><div class="line">        ListenerInfo li = mListenerInfo;</div><div class="line">        <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</div><div class="line">            ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</div><div class="line">                    (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</div><div class="line">            <span class="keyword">int</span> numListeners = listenersCopy.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</div><div class="line">                listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</div><div class="line">    mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>mLeft,mTop,mBottom,mRight表示当前View在parentView中的位置信息。<br>首先判断在layout前是否需要调用onMeasure()并进行调用，然后将位置信息暂存下来。根据布局边界模式调用setFrame()或setOpticalFrame()方法。<a href="https://developer.android.com/about/versions/android-4.3.html" target="_blank" rel="external">Optical Bounds</a>（视觉边界）是Android在4.3版本针对.9图引入的API。其中setOpticalFrame()对边界的尺寸做一些计算之后直接调用setFrame()方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">setFrame</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mLeft != left || mRight != right || mTop != top || mBottom != bottom) &#123;</div><div class="line">        changed = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Remember our drawn bit</span></div><div class="line">        <span class="keyword">int</span> drawn = mPrivateFlags &amp; PFLAG_DRAWN;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> oldWidth = mRight - mLeft;</div><div class="line">        <span class="keyword">int</span> oldHeight = mBottom - mTop;</div><div class="line">        <span class="keyword">int</span> newWidth = right - left;</div><div class="line">        <span class="keyword">int</span> newHeight = bottom - top;</div><div class="line">        <span class="keyword">boolean</span> sizeChanged = (newWidth != oldWidth) || (newHeight != oldHeight);</div><div class="line"></div><div class="line">        <span class="comment">// Invalidate our old position</span></div><div class="line">        invalidate(sizeChanged);</div><div class="line"></div><div class="line">        mLeft = left;</div><div class="line">        mTop = top;</div><div class="line">        mRight = right;</div><div class="line">        mBottom = bottom;</div><div class="line">        mRenderNode.setLeftTopRightBottom(mLeft, mTop, mRight, mBottom);</div><div class="line"></div><div class="line">        mPrivateFlags |= PFLAG_HAS_BOUNDS;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (sizeChanged) &#123;</div><div class="line">            sizeChange(newWidth, newHeight, oldWidth, oldHeight);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || mGhostView != <span class="keyword">null</span>) &#123;</div><div class="line">            mPrivateFlags |= PFLAG_DRAWN;</div><div class="line">            invalidate(sizeChanged);</div><div class="line">            <span class="comment">// parent display list may need to be recreated based on a change in the bounds</span></div><div class="line">            <span class="comment">// of any child</span></div><div class="line">            invalidateParentCaches();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Reset drawn bit to original value (invalidate turns it off)</span></div><div class="line">        mPrivateFlags |= drawn;</div><div class="line"></div><div class="line">        mBackgroundSizeChanged = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (mForegroundInfo != <span class="keyword">null</span>) &#123;</div><div class="line">            mForegroundInfo.mBoundsChanged = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> changed;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>setFrame()</code>方法中，根据View的位置和尺寸的变化，选择性调用<code>invalidate()</code>和<code>sizeChanged()</code>方法。<code>sizeChanged()</code>方法调用<code>onSizeChanged()</code>方法。在自定义View时，重写<code>onSizedChanged()</code>方法能很方便地检查View尺寸的变化。如果View保存的mLeft,mTop,mRight,mBottom与setFrame()传入的left,top,right,bottom中有一个不一样，setFrame()就会返回true。回到layout()方法中，如果setFrame()返回true或者设置了需要Layout的FLAG,就会调用onLayout()方法，并且获取调用所有的OnLayoutChangeListener。<br>View的onLayout()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这是一个空方法，因为在layout()方法中设置好了View自身的位置，onLayout()方法需要设置child View的位置，所以View的onLayout()方法是空方法，具体的实现在对应的ViewGroup中。<br>在ViewGroup中，onLayout()是一个abstract方法，表示继承类必须重写这个方法。同样地，看一下FrameLayout的onLayout()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">    layoutChildren(left, top, right, bottom, <span class="keyword">false</span> <span class="comment">/* no force left gravity */</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom,</span></span></div><div class="line">                              <span class="keyword">boolean</span> forceLeftGravity) &#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentLeft = getPaddingLeftWithForeground();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentRight = right - left - getPaddingRightWithForeground();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentTop = getPaddingTopWithForeground();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentBottom = bottom - top - getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        <span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">        <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">            <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> width = child.getMeasuredWidth();</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> height = child.getMeasuredHeight();</div><div class="line"></div><div class="line">            <span class="keyword">int</span> childLeft;</div><div class="line">            <span class="keyword">int</span> childTop;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> gravity = lp.gravity;</div><div class="line">            <span class="keyword">if</span> (gravity == -<span class="number">1</span>) &#123;</div><div class="line">                gravity = DEFAULT_CHILD_GRAVITY;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line"></div><div class="line">            <span class="keyword">switch</span> (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</div><div class="line">                <span class="keyword">case</span> Gravity.CENTER_HORIZONTAL:</div><div class="line">                    childLeft = parentLeft + (parentRight - parentLeft - width) / <span class="number">2</span> +</div><div class="line">                    lp.leftMargin - lp.rightMargin;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> Gravity.RIGHT:</div><div class="line">                    <span class="keyword">if</span> (!forceLeftGravity) &#123;</div><div class="line">                        childLeft = parentRight - width - lp.rightMargin;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                <span class="keyword">case</span> Gravity.LEFT:</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    childLeft = parentLeft + lp.leftMargin;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">switch</span> (verticalGravity) &#123;</div><div class="line">                <span class="keyword">case</span> Gravity.TOP:</div><div class="line">                    childTop = parentTop + lp.topMargin;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> Gravity.CENTER_VERTICAL:</div><div class="line">                    childTop = parentTop + (parentBottom - parentTop - height) / <span class="number">2</span> +</div><div class="line">                    lp.topMargin - lp.bottomMargin;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> Gravity.BOTTOM:</div><div class="line">                    childTop = parentBottom - height - lp.bottomMargin;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    childTop = parentTop + lp.topMargin;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>遍历child View，根据childView在水平和竖直方向的Gravity，计算对应的位置，然后调用child View的layout()方法，设置child View的位置。</p>
<p>最后进入到draw流程：<br>draw流程的调用来源：<br><code>ViewRootImpl.performTraversals()</code>-&gt;<code>ViewRootImpl.performDraw()</code>-&gt;<code>ViewRootImpl.draw(boolean fullRedrawNeeded)</code>-&gt;<code>ViewRootImpl.drawSoftware()</code><br>在ViewRootImpl中有一个Surface对象mSurface，代表一块屏幕缓存区。<br>在drawSoftware()方法中，调用mSurface.lockCanvas()获取了一个Canvas对象，用来绘制。后面所有的绘制操作都在这个Canvas上。然后调用DecorView的draw()方法开始绘制。在绘制流程完成之后调用mSurface.unlockCanvasAndPost()将绘制的结果交给SurfaceFling服务进行渲染。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</div><div class="line">            (mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);</div><div class="line">    mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Draw traversal performs several drawing steps which must be executed</div><div class="line">     * in the appropriate order:</div><div class="line">     *</div><div class="line">     *      1. Draw the background</div><div class="line">     *      2. If necessary, save the canvas' layers to prepare for fading</div><div class="line">     *      3. Draw view's content</div><div class="line">     *      4. Draw children</div><div class="line">     *      5. If necessary, draw the fading edges and restore layers</div><div class="line">     *      6. Draw decorations (scrollbars for instance)</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">// Step 1, draw the background, if needed</span></div><div class="line">    <span class="keyword">int</span> saveCount;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!dirtyOpaque) &#123;</div><div class="line">        drawBackground(canvas);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line">    <span class="keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="number">0</span>;</div><div class="line">    <span class="keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</div><div class="line">        <span class="comment">// Step 3, draw the content</span></div><div class="line">        <span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">        <span class="comment">// Step 4, draw the children</span></div><div class="line">        dispatchDraw(canvas);</div><div class="line"></div><div class="line">        <span class="comment">// Overlay is part of the content and draws beneath Foreground</span></div><div class="line">        <span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">            mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Step 6, draw decorations (foreground, scrollbars)</span></div><div class="line">        onDrawForeground(canvas);</div><div class="line"></div><div class="line">        <span class="comment">// we're done...</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Here we do the full fledged routine...</div><div class="line">     * (this is an uncommon case where speed matters less,</div><div class="line">     * this is why we repeat some of the tests that have been</div><div class="line">     * done above)</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">// hide the full fledged routine...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/18/android-classloader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Jilong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘怜苏">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/18/android-classloader/" itemprop="url">Android中的ClassLoader（PathClassLoader和DexClassLoder）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-18T09:44:00+08:00">
                2016-07-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在研究插件动态加载，记录一下其中<code>ClassLoader</code>部分的内容.</p>
<p>Android中的<code>ClassLoader</code>与Java有些不同，Android中<code>ClassLoader</code>加载的是dex文件，而Java中加载的是jar文件.相同的是两者都采用了双亲委派模型.<code>ClassLoader</code>中<code>loadClass</code>函数体现了这个模型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String className, <span class="keyword">boolean</span> resolve)</div><div class="line">    <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">    Class&lt;?&gt; clazz = findLoadedClass(className);<span class="comment">// 首先检查Class是否已经加载过</span></div><div class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</div><div class="line">        ClassNotFoundException suppressed = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            clazz = parent.loadClass(className, <span class="keyword">false</span>);<span class="comment">//尝试使用parent ClassLoader去加载Class</span></div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">            suppressed = e;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                clazz = findClass(className);<span class="comment">// 如果加载不成功，调用findClass函数来获取class对象.</span></div><div class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                e.addSuppressed(suppressed);</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> clazz;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中<code>findClass()</code>为protected，直接抛出异常，需要子类来实现具体的find过程.Android中<code>ClassLoader</code>的子类是<code>BaseDexClassLoder</code>,同时有<code>PathClassLoader</code>和<code>DexClassLoder</code>两个类直接继承自<code>BaseDexClassLoder</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DexClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DexClassLoader</span><span class="params">(String dexPath, String optimizedDirectory,</span></span></div><div class="line">            String libraryPath, ClassLoader parent) &#123;</div><div class="line">        <span class="keyword">super</span>(dexPath, <span class="keyword">new</span> File(optimizedDirectory), libraryPath, parent);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, ClassLoader parent)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(dexPath, <span class="keyword">null</span>, <span class="keyword">null</span>, parent);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, String libraryPath,</span></span></div><div class="line">            ClassLoader parent) &#123;</div><div class="line">        <span class="keyword">super</span>(dexPath, <span class="keyword">null</span>, libraryPath, parent);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDexClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span>｛</span></div><div class="line">    /**</div><div class="line">     * <span class="title">Constructs</span> <span class="title">an</span> <span class="title">instance</span>.</div><div class="line">     *</div><div class="line">     * @<span class="title">param</span> <span class="title">dexPath</span> <span class="title">the</span> <span class="title">list</span> <span class="title">of</span> <span class="title">jar</span>/<span class="title">apk</span> <span class="title">files</span> <span class="title">containing</span> <span class="title">classes</span> <span class="title">and</span></div><div class="line">     * <span class="title">resources</span>, <span class="title">delimited</span> <span class="title">by</span> &#123;<span class="meta">@code</span> File.pathSeparator&#125;, which</div><div class="line">     * defaults to &#123;<span class="meta">@code</span> <span class="string">":"</span>&#125; on Android</div><div class="line">     * <span class="meta">@param</span> optimizedDirectory directory where optimized dex files</div><div class="line">     * should be written; may be &#123;<span class="meta">@code</span> <span class="keyword">null</span>&#125;</div><div class="line">     * <span class="meta">@param</span> libraryPath the list of directories containing <span class="keyword">native</span></div><div class="line">     * libraries, delimited by &#123;<span class="meta">@code</span> File.pathSeparator&#125;; may be</div><div class="line">     * &#123;<span class="meta">@code</span> <span class="keyword">null</span>&#125;</div><div class="line">     * <span class="meta">@param</span> parent the parent <span class="class"><span class="keyword">class</span> <span class="title">loader</span></span></div><div class="line">     */</div><div class="line">    <span class="title">public</span> <span class="title">BaseDexClassLoader</span>(<span class="title">String</span> <span class="title">dexPath</span>, <span class="title">File</span> <span class="title">optimizedDirectory</span>,</div><div class="line">            <span class="title">String</span> <span class="title">libraryPath</span>, <span class="title">ClassLoader</span> <span class="title">parent</span>) &#123;</div><div class="line">        <span class="keyword">super</span>(parent);</div><div class="line">        <span class="keyword">this</span>.originalPath = dexPath;</div><div class="line">        <span class="keyword">this</span>.pathList =</div><div class="line">            <span class="keyword">new</span> DexPathList(<span class="keyword">this</span>, dexPath, libraryPath, optimizedDirectory);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">        Class clazz = pathList.findClass(name);</div><div class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> clazz;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//more code</span></div><div class="line">｝</div></pre></td></tr></table></figure></p>
<p><code>DexClassLoader</code>和<code>PathClassLoader</code>都直接调用<code>BaseDexClassLoader</code>的构造函数，区别是传入的参数不一样，<code>PathClassLoader</code>的super调用中，传入的<code>optimizedDirectory</code>一直为null.<code>BaseDexClassLoder</code>的构造函数使用入参的三个路径构造了一个<code>DexPathList</code>对象.同时<code>findClass()</code>直接使用<code>DexPathList</code>的<code>findClass()</code>函数.看一下<code>DexPathList</code>的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*package*/</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DexPathList</span> </span>&#123;</div><div class="line">    <span class="comment">/** list of dex/resource (class path) elements */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Element[] dexElements;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DexPathList</span><span class="params">(ClassLoader definingContext, String dexPath,</span></span></div><div class="line">            String libraryPath, File optimizedDirectory) &#123;</div><div class="line">        <span class="comment">// some error checking</span></div><div class="line">        <span class="keyword">this</span>.definingContext = definingContext;</div><div class="line">        <span class="keyword">this</span>.dexElements =</div><div class="line">            makeDexElements(splitDexPath(dexPath), optimizedDirectory);</div><div class="line">        <span class="keyword">this</span>.nativeLibraryDirectories = splitLibraryPath(libraryPath);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">findClass</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Element element : dexElements) &#123;</div><div class="line">            DexFile dex = element.dexFile;</div><div class="line">            <span class="keyword">if</span> (dex != <span class="keyword">null</span>) &#123;</div><div class="line">                Class clazz = dex.loadClassBinaryName(name, definingContext);</div><div class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> clazz;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/*package*/</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Element</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> File file;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> ZipFile zipFile;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> DexFile dexFile;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>DexPathList</code>的构造函数将传入的路径转化为<code>Element</code>数组，<code>findClass()</code>中遍历<code>Element</code>中的<code>DexFile</code>来加载<code>Class</code>，看一下<code>Element</code>数组的生成过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Makes an array of dex/resource path elements, one per element of</div><div class="line"> * the given array.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Element[] makeDexElements(ArrayList&lt;File&gt; files,</div><div class="line">        File optimizedDirectory) &#123;</div><div class="line">    ArrayList&lt;Element&gt; elements = <span class="keyword">new</span> ArrayList&lt;Element&gt;();</div><div class="line">    <span class="keyword">for</span> (File file : files) &#123;</div><div class="line">        ZipFile zip = <span class="keyword">null</span>;</div><div class="line">        DexFile dex = <span class="keyword">null</span>;</div><div class="line">        String name = file.getName();</div><div class="line">        <span class="keyword">if</span> (name.endsWith(DEX_SUFFIX)) &#123; <span class="comment">// 文件后缀为.dex</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                dex = loadDexFile(file, optimizedDirectory);<span class="comment">//1.加载dex文件</span></div><div class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">                System.logE(<span class="string">"Unable to load dex file: "</span> + file, ex);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.endsWith(APK_SUFFIX) || name.endsWith(JAR_SUFFIX)</div><div class="line">                || name.endsWith(ZIP_SUFFIX)) &#123;<span class="comment">// 文件为压缩包</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                zip = <span class="keyword">new</span> ZipFile(file);<span class="comment">//构造zip对象</span></div><div class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">                System.logE(<span class="string">"Unable to open zip file: "</span> + file, ex);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                dex = loadDexFile(file, optimizedDirectory);<span class="comment">//2.加载dex文件</span></div><div class="line">            &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</div><div class="line">                 <span class="comment">// 如果压缩文件中没有dex文件，抛出这个异常，可以直接无视</span></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.logW(<span class="string">"Unknown file type for: "</span> + file);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((zip != <span class="keyword">null</span>) || (dex != <span class="keyword">null</span>)) &#123;<span class="comment">//如果同时有zip和dex文件，就构造对应的Element</span></div><div class="line">            elements.add(<span class="keyword">new</span> Element(file, zip, dex));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> elements.toArray(<span class="keyword">new</span> Element[elements.size()]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用了两次<code>loadDexFile()</code>来生成dex对象，第一次的file为dex文件，第二次的file是压缩文件(zip,jar,apk).看一下对应的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DexFile <span class="title">loadDexFile</span><span class="params">(File file, File optimizedDirectory)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException &#123;</div><div class="line">    <span class="keyword">if</span> (optimizedDirectory == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DexFile(file);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        String optimizedPath = optimizedPathFor(file, optimizedDirectory);</div><div class="line">        <span class="keyword">return</span> DexFile.loadDex(file.getPath(), optimizedPath, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>根据<code>optimizedDirectory</code>是否为<code>null</code>调用不同的方法来构造DexFile.这两种构造方法最后都会调用<code>openDexFile()</code>这个native函数.其中<code>outputName</code>就是<code>optimizedDirectory</code>.回到前面看，<code>PathClassLoader</code>和<code>DexClassLoader</code>的区别是<code>optimizedDirectory</code>是否为<code>null</code>,对应<code>openDexFile()</code>中<code>outputName</code>是否为<code>null</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// java code</span></div><div class="line"><span class="function"><span class="keyword">native</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">openDexFile</span><span class="params">(String sourceName, String outputName,</span></span></div><div class="line">    <span class="keyword">int</span> flags) <span class="keyword">throws</span> IOException;</div></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// native code</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Dalvik_dalvik_system_DexFile_openDexFile</span><span class="params">(<span class="keyword">const</span> u4* args,</span></span></div><div class="line">    JValue* pResult)</div><div class="line">&#123;</div><div class="line">    <span class="comment">// ....</span></div><div class="line">    <span class="keyword">if</span> (hasDexExtension(sourceName)</div><div class="line">            &amp;&amp; dvmRawDexFileOpen(sourceName, outputName, &amp;pRawDexFile, <span class="literal">false</span>) == <span class="number">0</span>) &#123;</div><div class="line">        ALOGV(<span class="string">"Opening DEX file '%s' (DEX)"</span>, sourceName);</div><div class="line">        pDexOrJar = (DexOrJar*) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(DexOrJar));</div><div class="line">        pDexOrJar-&gt;isDex = <span class="literal">true</span>;</div><div class="line">        pDexOrJar-&gt;pRawDexFile = pRawDexFile;</div><div class="line">        pDexOrJar-&gt;pDexMemory = <span class="literal">NULL</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dvmJarFileOpen(sourceName, outputName, &amp;pJarFile, <span class="literal">false</span>) == <span class="number">0</span>) &#123;</div><div class="line">        ALOGV(<span class="string">"Opening DEX file '%s' (Jar)"</span>, sourceName);</div><div class="line">        pDexOrJar = (DexOrJar*) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(DexOrJar));</div><div class="line">        pDexOrJar-&gt;isDex = <span class="literal">false</span>;</div><div class="line">        pDexOrJar-&gt;pJarFile = pJarFile;</div><div class="line">        pDexOrJar-&gt;pDexMemory = <span class="literal">NULL</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ALOGV(<span class="string">"Unable to open DEX file '%s'"</span>, sourceName);</div><div class="line">        dvmThrowIOException(<span class="string">"unable to open DEX file"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//....</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>加载dex文件的过程在<code>dvmRawDexFileOpen()</code>和<code>dvmJarFileOpen()</code>方法中完成.看一下<code>dvmJarFileOpen()</code>的代码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">dvmJarFileOpen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* fileName, <span class="keyword">const</span> <span class="keyword">char</span>* odexOutputName,</span></span></div><div class="line">    JarFile** ppJarFile, <span class="keyword">bool</span> isBootstrap)</div><div class="line">&#123;</div><div class="line">tryArchive:</div><div class="line">        entry = dexZipFindEntry(&amp;archive, kDexInJarName);</div><div class="line">        <span class="keyword">if</span> (entry != <span class="literal">NULL</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (odexOutputName == <span class="literal">NULL</span>) &#123;</div><div class="line">                cachedName = dexOptGenerateCacheFileName(fileName,</div><div class="line">                                kDexInJarName);</div><div class="line">                <span class="keyword">if</span> (cachedName == <span class="literal">NULL</span>)</div><div class="line">                    <span class="keyword">goto</span> bail;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                cachedName = strdup(odexOutputName);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">bail:</div><div class="line">        <span class="comment">/* clean up, closing the open file */</span></div><div class="line">        <span class="keyword">if</span> (archiveOpen &amp;&amp; result != <span class="number">0</span>)</div><div class="line">            dexZipCloseArchive(&amp;archive);</div><div class="line">        <span class="built_in">free</span>(cachedName);</div><div class="line">        <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (locked)</div><div class="line">                (<span class="keyword">void</span>) dvmUnlockCachedDexFile(fd);</div><div class="line">            close(fd);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在<code>odexOutputName</code>为<code>null</code>的情况下，会直接返回一个ERROR，表示加载失败。</p>
<p>所以<code>PathClassLoader</code>只能加载dex格式的文件，而<code>DexClassLoader</code>可以加载dex文件，对于apk等压缩文件，加载过程会将压缩文件中的class.dex解压到<code>optimizedDirectory</code>目录中进行加载。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Liu Jilong" />
          <p class="site-author-name" itemprop="name">Liu Jilong</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Jilong</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
